# ğŸ¨ Diagram Implementasi Midtrans Dynamic Loading

## ğŸ“Š Arsitektur Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ROASTY PAYMENT SYSTEM                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FRONTEND (FE)    â”‚                    â”‚   BACKEND (BE)     â”‚
â”‚                    â”‚                    â”‚                    â”‚
â”‚  halaman.         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  .env              â”‚
â”‚  pembayaran.html  â”‚                    â”‚  â”œâ”€ MIDTRANS_      â”‚
â”‚                    â”‚   JSON Response    â”‚  â”‚  CLIENT_KEY     â”‚
â”‚  config.js         â”‚  {client_key}      â”‚  â”œâ”€ MIDTRANS_      â”‚
â”‚                    â”‚                    â”‚  â”‚  SERVER_KEY     â”‚
â”‚                    â”‚                    â”‚  â””â”€ MIDTRANS_      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚     IS_PRODUCTION  â”‚
         â–²                                 â”‚                    â”‚
         â”‚                                 â”‚  OrderController   â”‚
         â”‚          GET /api/             â”‚  â”œâ”€ getMidtrans    â”‚
         â”‚          midtrans-config       â”‚  â”‚  Config()       â”‚
         â”‚                                 â”‚  â””â”€ store()       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â”‚  routes/api.php
                                          â”‚  â”œâ”€ /midtrans-config (PUBLIC)
                                          â”‚  â””â”€ /orders (AUTH)
                                          â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                                    â”‚  Midtrans  â”‚
                                    â”‚  API       â”‚
                                    â”‚  (Payment) â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Sequence Diagram - Payment Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Browser â”‚                    â”‚  BE/API      â”‚           â”‚Midtransâ”‚
â”‚ (User)   â”‚                    â”‚              â”‚           â”‚        â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                  â”‚                       â”‚
     â”‚ 1. Load halaman.pembayaran.html  â”‚                       â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                       â”‚
     â”‚                                  â”‚                       â”‚
     â”‚ 2. DOMContentLoaded event        â”‚                       â”‚
     â”‚    triggered                     â”‚                       â”‚
     â”‚ (internal)                       â”‚                       â”‚
     â”‚                                  â”‚                       â”‚
     â”‚ 3. Call loadMidtransScript()     â”‚                       â”‚
     â”‚ (internal)                       â”‚                       â”‚
     â”‚                                  â”‚                       â”‚
     â”‚ 4. GET /api/midtrans-config      â”‚                       â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                       â”‚
     â”‚                                  â”‚                       â”‚
     â”‚                5. Return config  â”‚                       â”‚
     â”‚                   {client_key}   â”‚                       â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
     â”‚                                  â”‚                       â”‚
     â”‚ 6. Create <script> dynamically   â”‚                       â”‚
     â”‚    with client_key               â”‚                       â”‚
     â”‚ (internal)                       â”‚                       â”‚
     â”‚                                  â”‚                       â”‚
     â”‚ 7. Load Midtrans Snap script     â”‚                       â”‚
     â”‚    from CDN with client_key      â”‚                       â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
     â”‚                                  â”‚                       â”‚
     â”‚ 8. window.snap.pay() ready!      â”‚                       â”‚
     â”‚ (internal)                       â”‚                       â”‚
     â”‚                                  â”‚                       â”‚
     â”‚ 9. User click "Bayar Sekarang"   â”‚                       â”‚
     â”‚ (internal)                       â”‚                       â”‚
     â”‚                                  â”‚                       â”‚
     â”‚ 10. POST /api/orders             â”‚                       â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                       â”‚
     â”‚                                  â”‚                       â”‚
     â”‚ 11. Create order, get snap token â”‚                       â”‚
     â”‚     (CONFIG_MIDTRANS from .env)  â”‚                       â”‚
     â”‚                                  â”‚                       â”‚
     â”‚ 12. Snap::getSnapToken()         â”‚                       â”‚
     â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                  â”‚                       â”‚
     â”‚                                  â”‚ Return snap_token     â”‚
     â”‚                                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”€â”‚
     â”‚                                  â”‚                       â”‚
     â”‚ 13. Return snap_token            â”‚                       â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
     â”‚                                  â”‚                       â”‚
     â”‚ 14. window.snap.pay(snap_token)  â”‚                       â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
     â”‚                                  â”‚                       â”‚
     â”‚ 15. Midtrans payment page        â”‚                       â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚ (User select payment method)     â”‚                       â”‚
     â”‚ (User input details)             â”‚                       â”‚
     â”‚ (User confirm payment)           â”‚                       â”‚
     â”‚                                  â”‚                       â”‚
     â”‚ 16. Payment result callback      â”‚                       â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
     â”‚                                  â”‚                       â”‚
     â”‚ 17. onSuccess/onPending/onError  â”‚                       â”‚
     â”‚ (internal)                       â”‚                       â”‚
     â”‚                                  â”‚                       â”‚
     â”‚ 18. Update order status          â”‚                       â”‚
     â”‚     (via webhook if enabled)     â”‚                       â”‚
     â”‚                                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                                  â”‚ (webhook notification)â”‚
     â”‚                                  â”‚                       â”‚
     â”‚ 19. Redirect to Halaman.beranda  â”‚                       â”‚
     â”‚ (internal)                       â”‚                       â”‚
     â”‚                                  â”‚                       â”‚
```

---

## ğŸ—ï¸ Component Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Frontend Components                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           halaman.pembayaran.html                    â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚  <div id="midtrans-script-container"></div>         â”‚  â”‚
â”‚  â”‚           â†“                                          â”‚  â”‚
â”‚  â”‚    (Script akan di-inject di sini)                  â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚  JavaScript:                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ loadMidtransScript()                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â””â”€ fetch(/api/midtrans-config)               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â””â”€ createElement('script')                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚       â””â”€ setAttribute('data-client-key', ...) â”‚  â”‚  â”‚
â”‚  â”‚  â”‚          â””â”€ appendChild(script)               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚             â””â”€ window.snap loaded âœ“           â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚  setupPaymentButton()                              â”‚  â”‚
â”‚  â”‚  â””â”€ fetch(/api/orders)                             â”‚  â”‚
â”‚  â”‚     â””â”€ window.snap.pay(snapToken)                  â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           config.js                             â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                  â”‚  â”‚
â”‚  â”‚  const CONFIG = {                               â”‚  â”‚
â”‚  â”‚    API_BASE_URL: "...",                         â”‚  â”‚
â”‚  â”‚    assets: "..."                                â”‚  â”‚
â”‚  â”‚    // No MIDTRANS_CLIENT_KEY!                   â”‚  â”‚
â”‚  â”‚  }                                              â”‚  â”‚
â”‚  â”‚                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Backend Components                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          routes/api.php                             â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚  Route::get('/midtrans-config',                      â”‚  â”‚
â”‚  â”‚    [OrderController::class, 'getMidtransConfig'])   â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚  Route::post('/orders',                             â”‚  â”‚
â”‚  â”‚    [OrderController::class, 'store']) [AUTH]        â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚      OrderController                                â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚  getMidtransConfig()  [PUBLIC]                      â”‚  â”‚
â”‚  â”‚  â””â”€ return {                                        â”‚  â”‚
â”‚  â”‚      client_key: config('midtrans.client_key'),    â”‚  â”‚
â”‚  â”‚      is_production: config('midtrans.is_...')      â”‚  â”‚
â”‚  â”‚    }                                                â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚  store()  [AUTH]                                    â”‚  â”‚
â”‚  â”‚  â””â”€ Config::$serverKey = config('midtrans.server') â”‚  â”‚
â”‚  â”‚     Snap::getSnapToken($params)                    â”‚  â”‚
â”‚  â”‚     return Order with snap_token                   â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          .env                                       â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚  MIDTRANS_MERCHANT_ID=G610858736                    â”‚  â”‚
â”‚  â”‚  MIDTRANS_SERVER_KEY=Mid-server-Pn...              â”‚  â”‚
â”‚  â”‚  MIDTRANS_CLIENT_KEY=Mid-client-xHI...            â”‚  â”‚
â”‚  â”‚  MIDTRANS_IS_PRODUCTION=true                        â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”€ Comparison: Old vs New Flow

### âŒ OLD (Hardcoded)
```
HTML Parse
  â†“
<script> tag found
  â†“
Load Midtrans with hardcoded data-client-key
  â†“
window.snap ready
  â†“
When user click pay:
  POST /api/orders
    â†“
  Backend use .env MIDTRANS_SERVER_KEY
    â†“
  Return snap_token
    â†“
  Call window.snap.pay(token)
    â†“
  ISSUE: client key di frontend mungkin outdated!
```

### âœ… NEW (Dynamic Fetch)
```
Page Load
  â†“
DOMContentLoaded
  â†“
loadMidtransScript()
  â†“
Fetch /api/midtrans-config
  â†“
Backend read .env MIDTRANS_CLIENT_KEY
  â†“
Return client_key from .env
  â†“
Create <script> with fresh client_key
  â†“
Load Midtrans with updated config
  â†“
window.snap ready
  â†“
When user click pay:
  POST /api/orders
    â†“
  Backend use .env MIDTRANS_SERVER_KEY
    â†“
  Return snap_token
    â†“
  Call window.snap.pay(token)
    â†“
  SUCCESS: client key always in sync!
```

---

## ğŸ“± Data Flow Detail

```
REQUEST: GET /api/midtrans-config
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend                                                 â”‚
â”‚ fetch(`${API_URL}/midtrans-config`)                      â”‚
â”‚                                                          â”‚
â”‚ HTTP GET http://localhost:8000/api/midtrans-config       â”‚
â”‚                                                          â”‚
â”‚ Headers: {                                               â”‚
â”‚   'Accept': 'application/json'                           â”‚
â”‚ }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ Route Match: /midtrans-config
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend (OrderController::getMidtransConfig)             â”‚
â”‚                                                          â”‚
â”‚ config('midtrans.client_key')                            â”‚
â”‚   â†“ reads from config/midtrans.php                       â”‚
â”‚   â†“ which reads from .env MIDTRANS_CLIENT_KEY            â”‚
â”‚   â†“ returns: "Mid-client-xHI5auaQWqaNfVJ"               â”‚
â”‚                                                          â”‚
â”‚ config('midtrans.is_production')                         â”‚
â”‚   â†“ reads from config/midtrans.php                       â”‚
â”‚   â†“ which reads from .env MIDTRANS_IS_PRODUCTION         â”‚
â”‚   â†“ returns: true                                        â”‚
â”‚                                                          â”‚
â”‚ return response()->json([                                â”‚
â”‚   'success' => true,                                     â”‚
â”‚   'data' => [                                            â”‚
â”‚     'client_key' => 'Mid-client-xHI5auaQWqaNfVJ',      â”‚
â”‚     'is_production' => true                             â”‚
â”‚   ]                                                      â”‚
â”‚ ])                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ HTTP 200 OK
                   â”‚ Content-Type: application/json
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend                                                 â”‚
â”‚                                                          â”‚
â”‚ const configData = await response.json()                 â”‚
â”‚ // {                                                     â”‚
â”‚ //   success: true,                                      â”‚
â”‚ //   data: {                                             â”‚
â”‚ //     client_key: 'Mid-client-xHI5auaQWqaNfVJ',        â”‚
â”‚ //     is_production: true                              â”‚
â”‚ //   }                                                   â”‚
â”‚ // }                                                     â”‚
â”‚                                                          â”‚
â”‚ const script = document.createElement('script')          â”‚
â”‚ script.src = 'https://app.midtrans.com/snap/snap.js'     â”‚
â”‚ script.setAttribute('data-client-key',                   â”‚
â”‚   configData.data.client_key)  // Use fresh value!       â”‚
â”‚                                                          â”‚
â”‚ document.getElementById('midtrans-script-container')     â”‚
â”‚   .appendChild(script)                                   â”‚
â”‚                                                          â”‚
â”‚ âœ“ Midtrans loaded with client_key from .env backend!    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Summary Diagram

```
                    OLD WAY (âŒ)
                    
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ config.js (Hardcoded)                   â”‚
â”‚ MIDTRANS_CLIENT_KEY = "Mid-client-xHI"  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”œâ”€â”€â–º HTML: <script data-client-key="...">
                   â”‚
                   â””â”€â”€â–º Problem: Must update 2-3 places


                    NEW WAY (âœ…)
                    
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BE/.env (Single source of truth)        â”‚
â”‚ MIDTRANS_CLIENT_KEY = "Mid-client-xHI"  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”œâ”€â”€â–º /api/midtrans-config endpoint
                   â”‚
                   â”œâ”€â”€â–º Frontend fetch & inject script
                   â”‚
                   â””â”€â”€â–º Solution: Update only .env once!
```

---

## ğŸ§  Memory/State Management

```
Before Page Load:
  paymentState = {
    cart: [],
    products: [],
    userData: null,
    ...
  }

During Page Load:
  DOMContentLoaded
    â”œâ”€ loadMidtransScript()
    â”‚   â””â”€ window.snap = <loaded by dynamic script>
    â”œâ”€ loadPaymentData()
    â”‚   â””â”€ paymentState.products = <fetched>
    â”‚   â””â”€ paymentState.userData = <fetched>
    â””â”€ setupNavigation()

When User Click "Bayar":
  setupPaymentButton()
    â”œâ”€ Get selected payment method
    â”œâ”€ Create order items
    â”œâ”€ POST /api/orders
    â”‚   â””â”€ Backend: Config::$serverKey = env('MIDTRANS_SERVER_KEY')
    â”‚   â””â”€ Return snap_token
    â”œâ”€ window.snap.pay(snapToken)
    â”‚   â””â”€ Uses client_key loaded dynamically
    â””â”€ Handle callback (success/error)
```

---

## ğŸ” Security Flow

```
PUBLIC DATA (Frontend can see):
  - client_key âœ“ (needed for payment form)
  - order_id âœ“
  - user_email âœ“
  - product_info âœ“

PRIVATE DATA (Only Backend):
  - server_key âœ— (never send to frontend)
  - merchant_id âœ— (only in backend)
  - payment_status âœ— (verified via webhook)

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Midtrans API     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                    â”‚
                    â–¼                    â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Frontend â”‚          â”‚ Backend  â”‚
              â”‚(client)  â”‚          â”‚(server)  â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â”‚client_keyâ”‚ â—„â”€â”€â”€â”€â”€â”€â”€ â”‚get from  â”‚
              â”‚          â”‚  API     â”‚.env      â”‚
              â”‚snap      â”‚ â—„â”€â”€â”€â”€â”€â”€â”€ â”‚snap      â”‚
              â”‚.pay()    â”‚  token   â”‚token     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              
              âœ“ Client key safe in API response
              âœ“ Server key never exposed
              âœ“ Snap token single-use
```

---

Setiap diagram menunjukkan aspek berbeda dari implementasi Midtrans dynamic loading! ğŸ¨

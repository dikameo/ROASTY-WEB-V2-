<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Roasty</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>
<body class="bg-gray-100">
<!-- Header -->
<header class="bg-white shadow-sm sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-16">
        <div class="flex items-center space-x-2">
            <span class="text-xl font-bold text-orange-600">Roasty Admin</span>
        </div>
        <div class="flex items-center gap-4">
            <span id="adminName" class="text-sm text-gray-600">Admin</span>
            <button onclick="logout()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium">
                Logout
            </button>
        </div>
    </div>
</header>

<!-- Main Content -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Tabs Navigation -->
    <div class="flex gap-4 mb-6 border-b">
        <button onclick="switchTab('products')" id="tab-products" class="px-4 py-2 font-medium border-b-2 border-orange-600 text-orange-600">
            Kelola Produk
        </button>
        <button onclick="switchTab('orders')" id="tab-orders" class="px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900">
            Kelola Pesanan
        </button>
    </div>

    <!-- Products Tab -->
    <div id="products-tab" class="space-y-6">
        <!-- Add Product Form -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold mb-4">Tambah Produk Baru</h2>
            <form id="addProductForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Produk</label>
                        <input type="text" id="productName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" placeholder="Nama produk">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Harga (Rp)</label>
                        <input type="number" id="productPrice" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" placeholder="Harga">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                    <textarea id="productDescription" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" rows="3" placeholder="Deskripsi produk"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">URL Gambar</label>
                    <input type="url" id="productImage" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" placeholder="https://...">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Stok</label>
                        <input type="number" id="productStock" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" placeholder="Jumlah stok">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                        <input type="text" id="productCategory" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" placeholder="Kategori">
                    </div>
                </div>
                <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 rounded-lg transition">
                    Tambah Produk
                </button>
            </form>
        </div>

        <!-- Products List -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="px-6 py-4 border-b">
                <h2 class="text-xl font-bold">Daftar Produk</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Nama</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Harga</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Stok</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Kategori</th>
                            <th class="px-6 py-3 text-center text-sm font-medium text-gray-700">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="productsList" class="divide-y divide-gray-200">
                        <!-- Products will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Orders Tab -->
    <div id="orders-tab" class="hidden space-y-6">
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="px-6 py-4 border-b">
                <h2 class="text-xl font-bold">Daftar Pesanan</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">ID Pesanan</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Pelanggan</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Total</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                            <th class="px-6 py-3 text-center text-sm font-medium text-gray-700">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="ordersList" class="divide-y divide-gray-200">
                        <!-- Orders will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full p-6 space-y-4">
        <h2 class="text-2xl font-bold">Edit Produk</h2>
        <form id="editProductForm" class="space-y-4">
            <input type="hidden" id="editProductId">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Produk</label>
                    <input type="text" id="editProductName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Harga (Rp)</label>
                    <input type="number" id="editProductPrice" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                <textarea id="editProductDescription" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" rows="3"></textarea>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Stok</label>
                    <input type="number" id="editProductStock" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                    <input type="text" id="editProductCategory" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none">
                </div>
            </div>
            <div class="flex gap-4">
                <button type="submit" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 rounded-lg transition">
                    Simpan
                </button>
                <button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 rounded-lg transition">
                    Batal
                </button>
            </div>
        </form>
    </div>
</div>

<script src="config.js"></script>
<script>
    const API_URL = CONFIG.API_BASE_URL;
    let allProducts = [];
    let allOrders = [];

    // Check auth
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('token');
        const userStr = localStorage.getItem('user');
        const user = userStr ? JSON.parse(userStr) : {};
        
        console.log('=== ADMIN DASHBOARD AUTH CHECK ===');
        console.log('Token:', token);
        console.log('User data:', user);
        
        // Only check if token exists - allow access to dashboard
        if (!token) {
            console.log('‚ùå No token found - redirecting to login');
            window.location.href = 'login.html';
            return;
        }
        
        // If token exists, allow access to dashboard
        console.log('‚úÖ Token found - granting access to admin dashboard');
        document.getElementById('adminName').textContent = `Hi, ${user.name || 'Admin'}`;
        loadProducts();
        loadOrders();
    });

    // Switch tabs
    function switchTab(tab) {
        document.getElementById('products-tab').classList.toggle('hidden', tab !== 'products');
        document.getElementById('orders-tab').classList.toggle('hidden', tab !== 'orders');
        
        if (tab === 'products') {
            document.getElementById('tab-products').classList.remove('border-transparent', 'text-gray-600');
            document.getElementById('tab-products').classList.add('border-orange-600', 'text-orange-600');
            document.getElementById('tab-orders').classList.remove('border-orange-600', 'text-orange-600');
            document.getElementById('tab-orders').classList.add('border-transparent', 'text-gray-600');
        } else {
            document.getElementById('tab-orders').classList.remove('border-transparent', 'text-gray-600');
            document.getElementById('tab-orders').classList.add('border-orange-600', 'text-orange-600');
            document.getElementById('tab-products').classList.remove('border-orange-600', 'text-orange-600');
            document.getElementById('tab-products').classList.add('border-transparent', 'text-gray-600');
        }
    }

    // Load products
    async function loadProducts() {
        try {
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_URL}/products`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            console.log('üì¶ Products API response:', data);
            
            // Handle different response structures
            if (Array.isArray(data)) {
                allProducts = data;
            } else if (Array.isArray(data.data)) {
                // Handle paginated response with data.data array
                allProducts = data.data;
            } else if (data.data && data.data.data && Array.isArray(data.data.data)) {
                // Handle Laravel pagination structure: { data: { data: [...], total: ... } }
                allProducts = data.data.data;
            } else if (data.data && typeof data.data === 'object') {
                allProducts = Object.values(data.data);
            } else {
                allProducts = [];
            }
            console.log('‚úÖ Extracted products:', allProducts);
            console.log('Products loaded:', allProducts);
            renderProducts();
        } catch (err) {
            console.error('Error loading products:', err);
            alert('Gagal memuat produk: ' + err.message);
        }
    }

    // Render products
    function renderProducts() {
        const tbody = document.getElementById('productsList');
        if (!Array.isArray(allProducts)) {
            console.error('allProducts is not an array:', allProducts);
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Error loading products</td></tr>';
            return;
        }
        const validProducts = allProducts.filter(product => product && product.name);
        tbody.innerHTML = validProducts.map(product => `
            <tr>
                <td class="px-6 py-4 text-sm text-gray-900">${product.name}</td>
                <td class="px-6 py-4 text-sm text-gray-900">Rp ${parseInt(product.price).toLocaleString('id-ID')}</td>
                <td class="px-6 py-4 text-sm text-gray-900">${product.stock || 0}</td>
                <td class="px-6 py-4 text-sm text-gray-900">${product.category || '-'}</td>
                <td class="px-6 py-4 text-center text-sm space-x-2">
                    <button onclick="editProduct(${product.id})" class="text-blue-600 hover:text-blue-800 font-medium">Edit</button>
                    <button onclick="deleteProduct(${product.id})" class="text-red-600 hover:text-red-800 font-medium">Hapus</button>
                </td>
            </tr>
        `).join('');
    }

    // Add product
    document.getElementById('addProductForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const token = localStorage.getItem('token');
        
        try {
            const res = await fetch(`${API_URL}/products`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: document.getElementById('productName').value,
                    price: parseInt(document.getElementById('productPrice').value),
                    description: document.getElementById('productDescription').value,
                    category: document.getElementById('productCategory').value,
                    stock: parseInt(document.getElementById('productStock').value),
                    image_url: document.getElementById('productImage').value
                })
            });

            if (!res.ok) throw new Error('Gagal menambah produk');
            
            alert('Produk berhasil ditambahkan!');
            document.getElementById('addProductForm').reset();
            loadProducts();
        } catch (err) {
            alert('Error: ' + err.message);
        }
    });

    // Edit product
    function editProduct(id) {
        const product = allProducts.find(p => p.id === id);
        if (!product) return;

        document.getElementById('editProductId').value = id;
        document.getElementById('editProductName').value = product.name;
        document.getElementById('editProductPrice').value = product.price;
        document.getElementById('editProductDescription').value = product.description || '';
        document.getElementById('editProductStock').value = product.stock || 0;
        document.getElementById('editProductCategory').value = product.category || '';
        
        document.getElementById('editModal').classList.remove('hidden');
    }

    // Close edit modal
    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
    }

    // Update product
    document.getElementById('editProductForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const token = localStorage.getItem('token');
        const id = document.getElementById('editProductId').value;

        try {
            const res = await fetch(`${API_URL}/products/${id}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: document.getElementById('editProductName').value,
                    price: parseInt(document.getElementById('editProductPrice').value),
                    description: document.getElementById('editProductDescription').value,
                    category: document.getElementById('editProductCategory').value,
                    stock: parseInt(document.getElementById('editProductStock').value)
                })
            });

            if (!res.ok) throw new Error('Gagal mengupdate produk');
            
            alert('Produk berhasil diupdate!');
            closeEditModal();
            loadProducts();
        } catch (err) {
            alert('Error: ' + err.message);
        }
    });

    // Delete product
    async function deleteProduct(id) {
        if (!confirm('Yakin ingin menghapus produk ini?')) return;

        const token = localStorage.getItem('token');
        try {
            const res = await fetch(`${API_URL}/products/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!res.ok) throw new Error('Gagal menghapus produk');
            
            alert('Produk berhasil dihapus!');
            loadProducts();
        } catch (err) {
            alert('Error: ' + err.message);
        }
    }

    // Load orders
    async function loadOrders() {
        try {
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_URL}/orders`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            console.log('üì¶ Orders API response:', data);
            
            // Handle different response structures
            if (Array.isArray(data)) {
                allOrders = data;
            } else if (Array.isArray(data.data)) {
                allOrders = data.data;
            } else if (data.data && data.data.data && Array.isArray(data.data.data)) {
                // Handle Laravel pagination structure: { data: { data: [...], total: ... } }
                allOrders = data.data.data;
            } else if (data.data && typeof data.data === 'object') {
                allOrders = Object.values(data.data);
            } else {
                allOrders = [];
            }
            console.log('‚úÖ Extracted orders:', allOrders);
            console.log('Orders loaded:', allOrders);
            renderOrders();
        } catch (err) {
            console.error('Error loading orders:', err);
        }
    }

    // Render orders
    function renderOrders() {
        const tbody = document.getElementById('ordersList');
        if (!Array.isArray(allOrders)) {
            console.error('allOrders is not an array:', allOrders);
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Error loading orders</td></tr>';
            return;
        }
        const validOrders = allOrders.filter(order => order && order.id);
        tbody.innerHTML = validOrders.map(order => `
            <tr>
                <td class="px-6 py-4 text-sm text-gray-900">#${order.id}</td>
                <td class="px-6 py-4 text-sm text-gray-900">${order.user?.name || '-'}</td>
                <td class="px-6 py-4 text-sm text-gray-900">Rp ${parseInt(order.total_price || 0).toLocaleString('id-ID')}</td>
                <td class="px-6 py-4 text-sm">
                    <span class="px-3 py-1 rounded-full text-xs font-medium ${
                        order.status === 'completed' ? 'bg-green-100 text-green-800' :
                        order.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                        'bg-red-100 text-red-800'
                    }">
                        ${order.status || 'pending'}
                    </span>
                </td>
                <td class="px-6 py-4 text-center text-sm space-x-2">
                    ${order.status === 'pending' ? `<button onclick="confirmOrder(${order.id})" class="text-green-600 hover:text-green-800 font-medium">Konfirmasi</button>` : ''}
                    <button onclick="deleteOrder(${order.id})" class="text-red-600 hover:text-red-800 font-medium">Hapus</button>
                </td>
            </tr>
        `).join('');
    }

    // Confirm order
    async function confirmOrder(id) {
        if (!confirm('Konfirmasi pembelian ini?')) return;

        const token = localStorage.getItem('token');
        try {
            const res = await fetch(`${API_URL}/orders/${id}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: 'completed' })
            });

            if (!res.ok) throw new Error('Gagal mengkonfirmasi pembelian');
            
            alert('Pembelian berhasil dikonfirmasi!');
            loadOrders();
        } catch (err) {
            alert('Error: ' + err.message);
        }
    }

    // Delete order
    async function deleteOrder(id) {
        if (!confirm('Yakin ingin menghapus pesanan ini?')) return;

        const token = localStorage.getItem('token');
        try {
            const res = await fetch(`${API_URL}/orders/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!res.ok) throw new Error('Gagal menghapus pesanan');
            
            alert('Pesanan berhasil dihapus!');
            loadOrders();
        } catch (err) {
            alert('Error: ' + err.message);
        }
    }

    // Logout
    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = 'login.html';
    }
</script>

</body>
</html>

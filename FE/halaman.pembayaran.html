<!DOCTYPE html>
<html lang="id" class="light">
<head>
    <meta charset="UTF-8">
    <title>Roasty - Checkout</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Midtrans -->
    <script src="https://app.sandbox.midtrans.com/snap/snap.js"
        data-client-key="Mid-client-xHIl5auaQWqaNfVJ"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: "#f26c0d"
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-50 font-[Plus Jakarta Sans]">

<!-- HEADER -->
<header class="bg-white shadow px-6 py-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-primary cursor-pointer" id="goHome">Roasty</h1>

    <div class="flex items-center gap-3">
        <div id="profile-avatar"
            class="w-9 h-9 rounded-full bg-cover bg-center border"></div>
        <span id="profile-name" class="text-sm font-semibold">User</span>
    </div>
</header>

<!-- MAIN -->
<main class="max-w-6xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- LEFT -->
    <div class="lg:col-span-2 space-y-6">

        <!-- ADDRESS -->
        <section class="bg-white p-6 rounded-xl shadow">
            <h2 class="font-bold mb-3">Alamat Pengiriman</h2>
            <p id="address-name" class="font-semibold"></p>
            <p id="address-phone" class="text-sm text-gray-600"></p>
            <p id="address-text" class="text-sm text-gray-600"></p>
        </section>

        <!-- CART -->
        <section class="bg-white p-6 rounded-xl shadow">
            <h2 class="font-bold mb-4">Pesanan</h2>

            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b">
                        <th>Produk</th>
                        <th class="text-right">Harga</th>
                        <th class="text-center">Qty</th>
                        <th class="text-right">Total</th>
                    </tr>
                </thead>
                <tbody id="cartItemsTable"></tbody>
            </table>
        </section>

        <!-- PAYMENT -->
        <section class="bg-white p-6 rounded-xl shadow">
            <h2 class="font-bold mb-4">Metode Pembayaran</h2>

            <label class="flex items-center gap-2 mb-2">
                <input type="radio" name="payment" value="bca_va" checked>
                BCA Virtual Account
            </label>

            <label class="flex items-center gap-2 mb-2">
                <input type="radio" name="payment" value="credit_card">
                Kartu Kredit / Debit
            </label>

            <label class="flex items-center gap-2">
                <input type="radio" name="payment" value="gopay">
                GoPay
            </label>
        </section>
    </div>

    <!-- RIGHT -->
    <div>
        <div id="order-summary" class="bg-white p-6 rounded-xl shadow sticky top-6">
            <h2 class="font-bold mb-4">Ringkasan</h2>

            <div id="summary-details" class="space-y-2 text-sm"></div>

            <div class="border-t mt-4 pt-4 flex justify-between font-bold">
                <span>Total</span>
                <span id="summary-total" class="text-primary"></span>
            </div>

            <button id="pay-button"
                class="mt-6 w-full bg-primary text-white py-3 rounded-lg font-bold hover:opacity-90">
                Bayar Sekarang
            </button>
        </div>
    </div>

</main>

<!-- SCRIPTS -->
<script src="config.js"></script>

<script>
const API_URL = CONFIG.API_BASE_URL;

let state = {
    products: [],
    user: null,
    shipping: 15000,
    service: 1000
};

function formatRp(v) {
    return 'Rp ' + v.toLocaleString('id-ID');
}

/* LOAD DATA */
async function loadData() {
    const token = localStorage.getItem('token');
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');

    if (!token) return location.href = 'login.html';
    if (!cart.length) return alert('Keranjang kosong');

    // USER
    const userRes = await fetch(`${API_URL}/me`, {
        headers: { Authorization: `Bearer ${token}` }
    });
    const userData = (await userRes.json()).data;
    state.user = userData;

    document.getElementById('profile-name').textContent = userData.name;
    document.getElementById('profile-avatar').style.backgroundImage =
        `url(${userData.profile_image || 'https://ui-avatars.com/api/?name=' + userData.name})`;

    document.getElementById('address-name').textContent = userData.name;
    document.getElementById('address-phone').textContent = userData.phone || '-';
    document.getElementById('address-text').textContent =
        userData.profile?.full_address || 'Alamat tidak tersedia';

    // PRODUCTS
    for (let c of cart) {
        const res = await fetch(`${API_URL}/products/${c.id}`);
        const prod = (await res.json()).data;
        prod.quantity = c.quantity;
        state.products.push(prod);
    }

    renderCart();
    renderSummary();
}

/* CART */
function renderCart() {
    const tbody = document.getElementById('cartItemsTable');
    tbody.innerHTML = '';

    state.products.forEach((p, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${p.name}</td>
            <td class="text-right">${formatRp(p.price)}</td>
            <td class="text-center">${p.quantity}</td>
            <td class="text-right font-bold text-primary">
                ${formatRp(p.price * p.quantity)}
            </td>
        `;
        tbody.appendChild(tr);
    });
}

/* SUMMARY */
function renderSummary() {
    const box = document.getElementById('summary-details');
    const subtotal = state.products.reduce((s, p) => s + p.price * p.quantity, 0);
    const total = subtotal + state.shipping + state.service;

    box.innerHTML = `
        <div class="flex justify-between">
            <span>Subtotal</span>
            <span>${formatRp(subtotal)}</span>
        </div>
        <div class="flex justify-between">
            <span>Ongkir</span>
            <span>${formatRp(state.shipping)}</span>
        </div>
        <div class="flex justify-between">
            <span>Layanan</span>
            <span>${formatRp(state.service)}</span>
        </div>
    `;

    document.getElementById('summary-total').textContent = formatRp(total);
}

/* PAY */
document.getElementById('pay-button').onclick = async () => {
    const token = localStorage.getItem('token');
    const paymentMethod =
        document.querySelector('input[name="payment"]:checked').value;

    const subtotal = state.products.reduce((s, p) => s + p.price * p.quantity, 0);
    const total = subtotal + state.shipping + state.service;

    const res = await fetch(`${API_URL}/orders`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({
            items: state.products.map(p => ({
                product_id: p.id,
                quantity: p.quantity,
                price: p.price
            })),
            subtotal,
            shipping_cost: state.shipping,
            total,
            payment_method: paymentMethod
        })
    });

    const data = await res.json();

    window.snap.pay(data.snap_token, {
        onSuccess() {
            localStorage.removeItem('cart');
            location.href = 'Halaman.beranda.html';
        }
    });
};

document.getElementById('goHome').onclick = () => {
    location.href = 'Halaman.beranda.html';
};

document.addEventListener('DOMContentLoaded', loadData);
</script>

</body>
</html>

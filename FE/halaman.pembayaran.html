<!DOCTYPE html>

<html class="light" lang="id"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Roasty - Checkout</title>
<!-- Fonts -->
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&amp;display=swap" rel="stylesheet"/>
<!-- Material Symbols -->
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<!-- Theme Configuration -->
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#f26c0d",
                        "primary-hover": "#d95a00",
                        "background-light": "#f8f7f5",
                        "background-dark": "#221710",
                        "surface-light": "#ffffff",
                        "surface-dark": "#2d2018",
                        "text-main-light": "#1c130d",
                        "text-main-dark": "#f4ece7",
                        "text-sec-light": "#9c6c49",
                        "text-sec-dark": "#d6bba9",
                        "border-light": "#e8d9ce",
                        "border-dark": "#4a3b32",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
<!-- Custom Styles for Animations -->
<style>
    /* Shipping method animation */
    label[name="shipping"] {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    label[name="shipping"].active {
        transform: scale(1.02);
    }

    /* Payment method animation */
    .payment-method-item {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .payment-method-item.active {
        box-shadow: 0 4px 12px rgba(242, 108, 13, 0.25);
    }

    /* Quantity control animation */
    .qty-minus, .qty-plus {
        transition: all 0.2s ease;
    }

    .qty-minus:active, .qty-plus:active {
        transform: scale(0.95);
    }

    /* Content expand animation for payment methods */
    [class*="border-t"] {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        max-height: 0;
        overflow: hidden;
        opacity: 0;
    }

    [class*="border-t"].active {
        max-height: 300px;
        opacity: 1;
        overflow: visible;
    }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark text-text-main-light dark:text-text-main-dark font-display antialiased min-h-screen flex flex-col">
<!-- Header -->
<header class="sticky top-0 z-50 bg-surface-light dark:bg-surface-dark border-b border-border-light dark:border-border-dark px-4 md:px-10 py-3 shadow-sm">
<div class="max-w-[1280px] mx-auto flex items-center justify-between">
<div class="flex items-center gap-2">
<a class="flex items-center gap-2 text-primary hover:opacity-80 transition-opacity" href="#">
<span class="material-symbols-outlined text-3xl">local_cafe</span>
<h2 class="text-xl font-bold tracking-tight text-text-main-light dark:text-text-main-dark">Roasty</h2>
</a>
<div class="hidden md:flex items-center gap-1 ml-6 px-3 py-1 rounded-full bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 text-xs font-bold border border-green-200 dark:border-green-800">
<span class="material-symbols-outlined text-[16px]">lock</span>
<span>Pembayaran Aman</span>
</div>
</div>
<div class="flex items-center gap-6">
<!-- Breadcrumbs embedded in header for mobile/tablet optimization or kept separate -->
<div class="hidden md:flex items-center text-sm">
<span class="text-text-sec-light dark:text-text-sec-dark font-medium">1. Keranjang</span>
<span class="material-symbols-outlined text-base mx-2 text-border-light dark:text-border-dark">chevron_right</span>
<span class="text-primary font-bold">2. Pengiriman &amp; Pembayaran</span>
<span class="material-symbols-outlined text-base mx-2 text-border-light dark:text-border-dark">chevron_right</span>
<span class="text-text-sec-light dark:text-text-sec-dark font-medium">3. Selesai</span>
</div>
<div class="bg-center bg-no-repeat bg-cover rounded-full size-9 ring-2 ring-offset-2 ring-primary/20 dark:ring-offset-background-dark" data-alt="User profile avatar showing a smiling person" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuB3x0Vla6ka1ASQKph9PLwSibZWorf-uClUq8sS8udhzyxnXYRAeSoNKmNNkJxEaQKSjMepEQ4GvuGiADtZLN5qDgjdJh2tQ4vDtwzSqegQILfwzQn3anlNgPkDhBAX3bZy9RHVRe3q63XAGsYJoKmPP3uBGyWf66Spgfxgtqt-6D32vGdsSvhpk7OzHlafefhmMGX17TdBluzw08wRXHyFqSJtfm1rx3larf1R-buMZRStU01KzRa9KXSsjAyPRmnBgGEDWehpyg");'>
</div>
</div>
</div>
</header>
<!-- Main Content -->
<main class="flex-grow w-full max-w-[1280px] mx-auto px-4 md:px-10 py-8">
<h1 class="text-2xl font-bold mb-6 text-text-main-light dark:text-text-main-dark">Checkout</h1>
<div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
<!-- Left Column: Checkout Form (approx 66%) -->
<div class="lg:col-span-8 space-y-6">
<!-- Section 1: Shipping Address -->
<section>
<div class="flex items-center justify-between mb-3">
<h2 class="text-lg font-bold">Alamat Pengiriman</h2>
</div>
<!-- Address Card (Styled from provided component) -->
<div class="relative overflow-hidden rounded-xl shadow-sm group">
<div class="absolute inset-0 bg-cover bg-center" data-alt="Abstract map pattern background orange gradient" style='background-image: linear-gradient(135deg, rgba(34, 23, 16, 0.7) 0%, rgba(34, 23, 16, 0.4) 100%), url("https://lh3.googleusercontent.com/aida-public/AB6AXuCiymvwf5yjnVgrArPzw16Ko3oQ3qDH_0q7gHV_aGDBzsty-5jUpVVbIAc9-87D-Jee0Ufj343ghLtCoacbhklldBtctVzrRFO4jXZ_qrz_r3dp7fhjnRXNZ7kDRjTyW3yJOhc7RSkyDUick1S3VBtJ7tgY8DCM8LptgtWeaheecqCkHJWrl7mELqOsNr5FjUaDorVcjRk1szfeDs2nK23IqyirSQML_XvQQFyQ4Yj6F1LYE8FWcYZQ-uWgVFjjR2S-88v30bMoCw");'>
</div>
<div class="relative p-6 flex flex-col sm:flex-row items-start sm:items-end justify-between gap-4">
<div class="flex-1 text-white">
<div class="flex items-center gap-2 mb-2">
<span class="material-symbols-outlined text-primary">location_on</span>
<span class="bg-primary/90 text-white text-xs px-2 py-0.5 rounded font-bold">Utama</span>
</div>
<h3 class="text-xl font-bold leading-tight mb-1">Kantor - Budi Santoso</h3>
<p class="text-white/90 text-sm leading-relaxed">+62 812-3456-7890</p>
<p class="text-white/90 text-sm leading-relaxed max-w-lg">
                                    Gedung Menara Karya, Lantai 15, Jl. H. R. Rasuna Said Blok X-5, Kuningan, Jakarta Selatan, 12950
                                </p>
</div>
<button class="bg-surface-light hover:bg-gray-50 text-text-main-light font-bold py-2 px-4 rounded-lg text-sm transition-colors shadow-sm flex items-center gap-2 whitespace-nowrap">
<span>Ubah Alamat</span>
</button>
</div>
<div class="absolute top-0 left-0 w-1 h-full bg-primary"></div>
</div>
</section>
<!-- Section 2: Order Items -->
<section class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark p-6 shadow-sm">
<h2 class="text-lg font-bold mb-4 flex items-center gap-2">
<span class="material-symbols-outlined text-primary">inventory_2</span>
                        Pesanan Anda
                    </h2>
<!-- Store Header -->
<div class="flex items-center gap-2 mb-4 pb-3 border-b border-border-light dark:border-border-dark">
<span class="material-symbols-outlined text-text-sec-light dark:text-text-sec-dark text-lg">storefront</span>
<span class="font-bold text-sm">Roasty Official Store</span>
<span class="bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 text-[10px] px-1.5 py-0.5 rounded font-bold uppercase">Official</span>
</div>
<!-- Items Table -->
<div class="w-full">
<table class="w-full">
<thead>
<tr class="text-left text-xs text-text-sec-light dark:text-text-sec-dark border-b border-dashed border-border-light dark:border-border-dark">
<th class="pb-2 font-medium w-16">Produk</th>
<th class="pb-2 font-medium">Detail</th>
<th class="pb-2 font-medium text-right hidden sm:table-cell">Harga Satuan</th>
<th class="pb-2 font-medium text-right">Jumlah</th>
<th class="pb-2 font-medium text-right w-24">Total</th>
</tr>
</thead>
<tbody class="divide-y divide-border-light dark:divide-border-dark" id="cartItemsTable">
<!-- Items akan di-generate oleh JavaScript -->
</tbody>
</table>
</div>
</section>
<!-- Section 3: Shipping Method -->
<section class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark p-6 shadow-sm">
<h2 class="text-lg font-bold mb-4 flex items-center gap-2">
<span class="material-symbols-outlined text-primary">local_shipping</span>
                        Pengiriman
                    </h2>
<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
<!-- Option 1: Reguler -->
<label class="relative flex cursor-pointer rounded-lg border-2 border-primary bg-primary/5 p-4 shadow-sm focus:outline-none">
<input checked="" class="sr-only" name="delivery-method" type="radio" value="reguler"/>
<span class="flex flex-1">
<span class="flex flex-col">
<span class="block text-sm font-bold text-text-main-light dark:text-text-main-dark">Reguler (JNE/J&amp;T)</span>
<span class="mt-1 flex items-center text-xs text-text-sec-light dark:text-text-sec-dark">Est. 2-3 Hari</span>
<span class="mt-2 text-sm font-bold text-primary">Rp 15.000</span>
</span>
</span>
<span class="material-symbols-outlined text-primary" data-fill="1" data-icon="check_circle">check_circle</span>
</label>
<!-- Option 2: Next Day -->
<label class="relative flex cursor-pointer rounded-lg border border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark p-4 shadow-sm hover:border-gray-300 dark:hover:border-gray-600 focus:outline-none">
<input class="sr-only" name="delivery-method" type="radio" value="nextday"/>
<span class="flex flex-1">
<span class="flex flex-col">
<span class="block text-sm font-bold text-text-main-light dark:text-text-main-dark">Next Day (SiCepat)</span>
<span class="mt-1 flex items-center text-xs text-text-sec-light dark:text-text-sec-dark">Est. 1 Hari</span>
<span class="mt-2 text-sm font-bold text-text-main-light dark:text-text-main-dark">Rp 28.000</span>
</span>
</span>
<span class="material-symbols-outlined text-gray-300">circle</span>
</label>
<!-- Option 3: Instant -->
<label class="relative flex cursor-pointer rounded-lg border border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark p-4 shadow-sm hover:border-gray-300 dark:hover:border-gray-600 focus:outline-none">
<input class="sr-only" name="delivery-method" type="radio" value="instant"/>
<span class="flex flex-1">
<span class="flex flex-col">
<span class="block text-sm font-bold text-text-main-light dark:text-text-main-dark">Instant (Gojek/Grab)</span>
<span class="mt-1 flex items-center text-xs text-text-sec-light dark:text-text-sec-dark">Est. 3-6 Jam</span>
<span class="mt-2 text-sm font-bold text-text-main-light dark:text-text-main-dark">Rp 45.000</span>
</span>
</span>
<span class="material-symbols-outlined text-gray-300">circle</span>
</label>
</div>
</section>
<!-- Section 4: Payment Method -->
<section class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark p-6 shadow-sm">
<h2 class="text-lg font-bold mb-4 flex items-center gap-2">
<span class="material-symbols-outlined text-primary">payments</span>
                        Metode Pembayaran
                    </h2>
<div class="space-y-3">
<!-- BCA Virtual Account -->
<div class="rounded-lg border border-border-light dark:border-border-dark overflow-hidden">
<label class="flex items-center p-4 cursor-pointer bg-surface-light dark:bg-surface-dark">
<input checked="" class="size-4 border-gray-300 text-primary focus:ring-primary" name="payment" type="radio"/>
<div class="ml-3 flex items-center justify-between flex-1">
<div class="flex items-center gap-3">
<div class="w-12 h-8 bg-blue-800 rounded flex items-center justify-center text-white text-[10px] font-bold tracking-wider">BCA</div>
<span class="block text-sm font-medium text-text-main-light dark:text-text-main-dark">BCA Virtual Account</span>
</div>
<span class="text-xs text-text-sec-light dark:text-text-sec-dark">Otomatis cek</span>
</div>
</label>
<!-- Expanded content for selected item (Simulated) -->
<div class="bg-background-light dark:bg-background-dark p-4 border-t border-border-light dark:border-border-dark ml-0">
<p class="text-sm text-text-sec-light dark:text-text-sec-dark mb-2">Biaya layanan: <strong>Rp 1.000</strong></p>
<div class="p-3 bg-blue-50 dark:bg-blue-900/20 text-blue-800 dark:text-blue-200 text-sm rounded border border-blue-100 dark:border-blue-800">
                                    Anda akan mendapatkan nomor Virtual Account setelah klik "Bayar Sekarang".
                                </div>
</div>
</div>
<!-- Credit Card -->
<div class="rounded-lg border border-border-light dark:border-border-dark overflow-hidden">
<label class="flex items-center p-4 cursor-pointer bg-surface-light dark:bg-surface-dark hover:bg-gray-50 dark:hover:bg-gray-800/50">
<input class="size-4 border-gray-300 text-primary focus:ring-primary" name="payment" type="radio"/>
<div class="ml-3 flex items-center justify-between flex-1">
<div class="flex items-center gap-3">
<div class="flex -space-x-2">
<div class="size-8 rounded-full bg-red-500/80"></div>
<div class="size-8 rounded-full bg-yellow-500/80"></div>
</div>
<span class="block text-sm font-medium text-text-main-light dark:text-text-main-dark">Kartu Kredit / Debit</span>
</div>
</div>
</label>
</div>
<!-- E-Wallet -->
<div class="rounded-lg border border-border-light dark:border-border-dark overflow-hidden">
<label class="flex items-center p-4 cursor-pointer bg-surface-light dark:bg-surface-dark hover:bg-gray-50 dark:hover:bg-gray-800/50">
<input class="size-4 border-gray-300 text-primary focus:ring-primary" name="payment" type="radio"/>
<div class="ml-3 flex items-center justify-between flex-1">
<div class="flex items-center gap-3">
<div class="w-12 h-8 bg-blue-400 rounded flex items-center justify-center text-white text-[10px] font-bold">GOPAY</div>
<span class="block text-sm font-medium text-text-main-light dark:text-text-main-dark">GoPay</span>
</div>
<span class="text-xs text-text-sec-light dark:text-text-sec-dark">Hubungkan akun</span>
</div>
</label>
</div>
</div>
</section>
</div>
<!-- Right Column: Sticky Summary (approx 33%) -->
<div class="lg:col-span-4 relative">
<div class="sticky top-24 flex flex-col gap-4">
<!-- Promo Code -->
<div class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark p-4 shadow-sm">
<label class="block text-sm font-bold mb-2 text-text-main-light dark:text-text-main-dark flex items-center gap-2">
<span class="material-symbols-outlined text-primary text-lg">confirmation_number</span>
                            Kode Promo &amp; Diskon
                        </label>
<div class="flex gap-2">
<input class="flex-1 rounded-lg border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark text-sm focus:ring-primary focus:border-primary" placeholder="Masukkan kode" type="text"/>
<button class="bg-gray-200 dark:bg-gray-700 text-text-main-light dark:text-text-main-dark font-bold px-4 py-2 rounded-lg text-sm hover:bg-gray-300 dark:hover:bg-gray-600">Pakai</button>
</div>
</div>
<!-- Order Summary -->
<div class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark p-6 shadow-lg shadow-gray-200/50 dark:shadow-none">
<h3 class="text-lg font-bold mb-5 pb-3 border-b border-border-light dark:border-border-dark">Ringkasan Belanja</h3>
<div class="space-y-3 mb-6">
<div class="flex justify-between text-sm">
<span class="text-text-sec-light dark:text-text-sec-dark">Total Harga (3 Barang)</span>
<span class="font-medium">Rp 230.000</span>
</div>
<div class="flex justify-between text-sm">
<span class="text-text-sec-light dark:text-text-sec-dark">Total Ongkos Kirim</span>
<span class="font-medium">Rp 15.000</span>
</div>
<div class="flex justify-between text-sm">
<span class="text-text-sec-light dark:text-text-sec-dark">Biaya Asuransi</span>
<span class="font-medium">Rp 2.000</span>
</div>
<div class="flex justify-between text-sm">
<span class="text-text-sec-light dark:text-text-sec-dark">Biaya Layanan</span>
<span class="font-medium">Rp 1.000</span>
</div>
<div class="flex justify-between text-sm text-primary">
<span class="font-medium">Diskon Ongkir</span>
<span class="font-bold">-Rp 10.000</span>
</div>
</div>
<div class="border-t border-dashed border-border-light dark:border-border-dark pt-4 mb-6">
<div class="flex justify-between items-center mb-1">
<span class="text-base font-bold text-text-main-light dark:text-text-main-dark">Total Tagihan</span>
<span class="text-xl font-bold text-primary">Rp 238.000</span>
</div>
<p class="text-xs text-text-sec-light dark:text-text-sec-dark text-right">Termasuk PPN jika berlaku</p>
</div>
<div class="mb-6 p-4 bg-primary/10 rounded-lg border border-primary/30">
<p class="text-xs text-text-sec-light dark:text-text-sec-dark mb-2">TOTAL HARGA</p>
<p class="text-2xl font-bold text-primary">Rp 238.000</p>
</div>
<button class="w-full bg-primary hover:bg-primary-hover text-white font-bold py-3.5 px-4 rounded-xl shadow-lg shadow-primary/30 transition-all transform active:scale-[0.98] flex items-center justify-center gap-2">
<span class="material-symbols-outlined">lock</span>
                            Bayar Sekarang
                        </button>
<div class="mt-4 flex items-center justify-center gap-2 text-xs text-text-sec-light dark:text-text-sec-dark">
<span class="material-symbols-outlined text-sm">verified_user</span>
<span>Transaksi ini dilindungi dan aman.</span>
</div>
</div>
</div>
</div>
</div>
</main>
<!-- Footer Simple -->
<footer class="mt-12 bg-surface-light dark:bg-surface-dark border-t border-border-light dark:border-border-dark py-8 text-center">
<p class="text-sm text-text-sec-light dark:text-text-sec-dark mb-2">© 2023 Roasty Marketplace. All rights reserved.</p>
<div class="flex justify-center gap-4 text-xs text-text-sec-light dark:text-text-sec-dark">
<a class="hover:text-primary" href="#">Syarat &amp; Ketentuan</a>
<a class="hover:text-primary" href="#">Kebijakan Privasi</a>
<a class="hover:text-primary" href="#">Bantuan</a>
</div>
</footer>

<script src="config.js"></script>
<script>
const API_URL = CONFIG.API_BASE_URL;
let paymentState = {
    cart: [],
    products: [],
    userData: null,
    shippingCost: 15000,
    insuranceCost: 2000,
    serviceCost: 1000,
    discount: 0
};

// Format currency
function formatCurrency(amount) {
    return 'Rp ' + parseInt(amount).toLocaleString('id-ID');
}

// Calculate totals
function calculateTotals() {
    const subtotal = paymentState.products.reduce((sum, prod) => sum + (prod.price * prod.quantity), 0);
    const total = subtotal + paymentState.shippingCost + paymentState.insuranceCost + paymentState.serviceCost - paymentState.discount;
    
    return {
        subtotal,
        shippingCost: paymentState.shippingCost,
        insuranceCost: paymentState.insuranceCost,
        serviceCost: paymentState.serviceCost,
        discount: paymentState.discount,
        total
    };
}

// Update address display
function updateAddressDisplay(profile) {
    const addressCard = document.querySelector('div.relative.overflow-hidden.rounded-xl');
    if (!addressCard) {
        console.warn('Address card not found in DOM');
        return;
    }
    
    if (!profile) {
        console.warn('No profile/address data provided');
        // Show default values
        const nameEl = addressCard.querySelector('h3.text-xl.font-bold');
        if (nameEl) nameEl.textContent = 'User';
        return;
    }
    
    // Handle both UserAddress and Profile models
    const fullName = profile.user?.name || profile.name || 'User';
    const phone = profile.phone_number || profile.phone || profile.phone || '+62 8xx xxxx xxxx';
    const address = profile.full_address || profile.address || 'Alamat tidak tersedia';
    
    console.log('Updating address display:', { fullName, phone, address });
    
    // Update name
    const nameEl = addressCard.querySelector('h3.text-xl.font-bold');
    if (nameEl) nameEl.textContent = fullName;
    
    // Update phone
    const phoneEl = addressCard.querySelector('p.text-white\\/90:first-of-type');
    if (phoneEl) phoneEl.textContent = phone;
    
    // Update address
    const addressEl = addressCard.querySelector('p.text-white\\/90.leading-relaxed.max-w-lg');
    if (addressEl) addressEl.textContent = address;
}

// Update summary display
function updateSummaryDisplay(totals) {
    const summaryContainer = document.querySelector('div.bg-surface-light.rounded-xl.border.border-border-light.dark\\:bg-surface-dark.dark\\:border-border-dark.p-6.shadow-lg');
    if (!summaryContainer) return;
    
    const itemCount = paymentState.products.reduce((sum, p) => sum + p.quantity, 0);
    
    // Update summary items
    const summaryText = summaryContainer.querySelector('div.space-y-3.mb-6');
    if (summaryText) {
        summaryText.innerHTML = `
            <div class="flex justify-between text-sm">
                <span class="text-text-sec-light dark:text-text-sec-dark">Total Harga (${itemCount} Barang)</span>
                <span class="font-medium">${formatCurrency(totals.subtotal)}</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-text-sec-light dark:text-text-sec-dark">Total Ongkos Kirim</span>
                <span class="font-medium">${formatCurrency(totals.shippingCost)}</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-text-sec-light dark:text-text-sec-dark">Biaya Asuransi</span>
                <span class="font-medium">${formatCurrency(totals.insuranceCost)}</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-text-sec-light dark:text-text-sec-dark">Biaya Layanan</span>
                <span class="font-medium">${formatCurrency(totals.serviceCost)}</span>
            </div>
            ${totals.discount > 0 ? `
                <div class="flex justify-between text-sm text-primary">
                    <span class="font-medium">Diskon Ongkir</span>
                    <span class="font-bold">-${formatCurrency(totals.discount)}</span>
                </div>
            ` : ''}
        `;
    }
    
    // Update total tagihan
    const totalEl = summaryContainer.querySelector('span.text-xl.font-bold.text-primary');
    if (totalEl) {
        totalEl.textContent = formatCurrency(totals.total);
    }
    
    // Update total harga display (new section above button)
    const totalHargaSection = summaryContainer.querySelector('div.bg-primary\\/10.rounded-lg.border.border-primary\\/30');
    if (totalHargaSection) {
        const totalHargaEl = totalHargaSection.querySelector('p.text-2xl.font-bold.text-primary');
        if (totalHargaEl) {
            totalHargaEl.textContent = formatCurrency(totals.total);
        }
    }
}

// Update cart items display

// Update cart items with quantity controls
function updateCartDisplayWithControls(products) {
    const tableBody = document.getElementById('cartItemsTable');
    if (!tableBody) {
        console.error('Cart table body not found!');
        return;
    }
    
    console.log('Updating cart display with products:', products);
    tableBody.innerHTML = '';
    
    if (products.length === 0) {
        console.warn('No products to display!');
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Tidak ada barang di keranjang</td></tr>';
        return;
    }
    
    products.forEach((product, index) => {
        const row = document.createElement('tr');
        const itemTotal = product.price * product.quantity;
        
        row.innerHTML = `
            <td class="py-4 align-top">
                <div class="size-16 rounded-lg bg-gray-100 dark:bg-gray-800 bg-cover bg-center border border-border-light dark:border-border-dark" style="background-image: url('${product.image_url || 'https://via.placeholder.com/64'}');"></div>
            </td>
            <td class="py-4 px-3 align-top">
                <p class="font-bold text-sm text-text-main-light dark:text-text-main-dark line-clamp-2">${product.name}</p>
                <p class="text-xs text-text-sec-light dark:text-text-sec-dark mt-1">Stok: Tersedia</p>
            </td>
            <td class="py-4 align-top text-right hidden sm:table-cell">
                <p class="text-sm font-medium">${formatCurrency(product.price)}</p>
            </td>
            <td class="py-4 align-top text-right">
                <div class="flex items-center gap-2 justify-end">
                    <button class="qty-minus size-8 flex items-center justify-center bg-gray-100 dark:bg-gray-800 rounded border border-border-light dark:border-border-dark hover:bg-primary hover:text-white transition-all duration-200" data-index="${index}">
                        <span class="material-symbols-outlined text-lg">remove</span>
                    </button>
                    <span class="qty-display w-8 text-center font-medium">${product.quantity}</span>
                    <button class="qty-plus size-8 flex items-center justify-center bg-gray-100 dark:bg-gray-800 rounded border border-border-light dark:border-border-dark hover:bg-primary hover:text-white transition-all duration-200" data-index="${index}">
                        <span class="material-symbols-outlined text-lg">add</span>
                    </button>
                </div>
            </td>
            <td class="py-4 align-top text-right">
                <p class="text-sm font-bold text-primary item-total">${formatCurrency(itemTotal)}</p>
            </td>
        `;
        
        tableBody.appendChild(row);
        console.log(`Added product ${product.id} (${product.name}) with quantity ${product.quantity}`);
        
        // Setup quantity controls
        const minusBtn = row.querySelector('.qty-minus');
        const plusBtn = row.querySelector('.qty-plus');
        
        if (!minusBtn || !plusBtn) {
            console.error('Buttons not found for product:', product);
            return;
        }
        
        minusBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (product.quantity > 1) {
                product.quantity--;
                console.log(`Decreased quantity for ${product.name} to ${product.quantity}`);
                const totals = calculateTotals();
                updateSummaryDisplay(totals);
                updateCartDisplayWithControls(paymentState.products);
            }
        });
        
        plusBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            product.quantity++;
            console.log(`Increased quantity for ${product.name} to ${product.quantity}`);
            const totals = calculateTotals();
            updateSummaryDisplay(totals);
            updateCartDisplayWithControls(paymentState.products);
        });
    });
    
    console.log('Cart display updated with', products.length, 'items');
}

// Update user avatar
function updateUserAvatar(userData) {
    try {
        const avatarEl = document.querySelector('div.bg-center.bg-no-repeat.bg-cover.rounded-full.size-9');
        if (!avatarEl) {
            console.warn('Avatar element not found');
            return;
        }
        
        if (userData && userData.profile_image) {
            avatarEl.style.backgroundImage = `url('${userData.profile_image}')`;
            console.log('✓ Avatar updated');
        } else {
            console.warn('No profile image found in user data');
        }
    } catch (err) {
        console.error('Error updating avatar:', err);
    }
}

// Setup shipping method UI with animations
function setupShippingMethodUI() {
    // Find all shipping radios directly
    const shippingRadios = document.querySelectorAll('input[name="delivery-method"]');
    if (shippingRadios.length === 0) return;
    
    shippingRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            // Update all labels
            shippingRadios.forEach(r => {
                const label = r.closest('label');
                if (!label) return;
                
                if (r === radio) {
                    // Selected label
                    label.classList.remove('border-border-light', 'dark:border-border-dark', 'bg-surface-light', 'dark:bg-surface-dark');
                    label.classList.add('border-primary', 'bg-primary/5');
                    
                    // Update icon
                    const icon = label.querySelector('.material-symbols-outlined');
                    if (icon) {
                        icon.textContent = 'check_circle';
                        icon.classList.remove('text-gray-300');
                        icon.classList.add('text-primary');
                    }
                } else {
                    // Unselected labels
                    label.classList.remove('border-primary', 'bg-primary/5');
                    label.classList.add('border-border-light', 'dark:border-border-dark', 'bg-surface-light', 'dark:bg-surface-dark');
                    
                    // Update icon
                    const icon = label.querySelector('.material-symbols-outlined');
                    if (icon) {
                        icon.textContent = 'circle';
                        icon.classList.remove('text-primary');
                        icon.classList.add('text-gray-300');
                    }
                }
            });
            
            // Update shipping cost
            if (this.value === 'reguler') {
                paymentState.shippingCost = 15000;
            } else if (this.value === 'nextday') {
                paymentState.shippingCost = 28000;
            } else if (this.value === 'instant') {
                paymentState.shippingCost = 45000;
            }
            
            const totals = calculateTotals();
            updateSummaryDisplay(totals);
        });
    });
}

// Setup payment method UI with animations
function setupPaymentMethodUI() {
    const paymentRadios = document.querySelectorAll('input[name="payment"]');
    if (paymentRadios.length === 0) return;
    
    paymentRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            // Update all payment containers
            paymentRadios.forEach(r => {
                const container = r.closest('.rounded-lg.border');
                if (!container) return;
                
                const label = container.querySelector('label');
                const content = container.querySelector('[class*="border-t"]');
                
                if (r === radio) {
                    // Selected payment method
                    if (label) {
                        label.classList.add('border-primary', 'bg-primary/5', 'shadow-md');
                        label.classList.remove('hover:bg-gray-50', 'dark:hover:bg-gray-800/50');
                    }
                    
                    // Show content with animation
                    if (content) {
                        setTimeout(() => {
                            content.style.maxHeight = '300px';
                            content.style.opacity = '1';
                            content.style.overflow = 'visible';
                        }, 10);
                    }
                } else {
                    // Unselected payment methods
                    if (label) {
                        label.classList.remove('border-primary', 'bg-primary/5', 'shadow-md');
                        label.classList.add('hover:bg-gray-50', 'dark:hover:bg-gray-800/50');
                    }
                    
                    // Hide content with animation
                    if (content) {
                        content.style.maxHeight = '0';
                        content.style.opacity = '0';
                        content.style.overflow = 'hidden';
                    }
                }
            });
        });
    });
}

// Load payment data
async function loadPaymentData() {
    const rawCart = localStorage.getItem('cart');
    console.log('Raw cart from localStorage:', rawCart);
    
    const cart = JSON.parse(rawCart || '[]');
    const token = localStorage.getItem('token');
    
    console.log('Parsed cart:', cart);
    console.log('Cart length:', cart.length);
    console.log('Token available:', !!token);
    
    if (!token) {
        alert('Silakan login terlebih dahulu');
        window.location.href = 'login.html';
        return;
    }
    
    if (cart.length === 0) {
        alert('Keranjang kosong');
        window.location.href = 'halaman.keranjang.belanja.html';
        return;
    }
    
    try {
        // Fetch user data
        console.log('Fetching user data from /me endpoint...');
        const userRes = await fetch(`${API_URL}/me`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/json'
            }
        });
        
        if (!userRes.ok) {
            console.error(`User fetch failed: ${userRes.status} ${userRes.statusText}`);
            if (userRes.status === 401) {
                localStorage.removeItem('token');
                alert('Sesi Anda telah berakhir. Silakan login kembali.');
                window.location.href = 'login.html';
            } else {
                alert('Gagal mengambil data user: ' + userRes.statusText);
            }
            return;
        }
        
        const userData = await userRes.json();
        const user = userData.data || userData;
        
        // Validate user data
        if (!user) {
            throw new Error('Invalid user data received from API');
        }
        
        console.log('Raw user data from API:', user);
        paymentState.userData = user;
        console.log('✓ User data loaded:', user);
        
        // Use profile from user data as address - ensure it exists
        let primaryAddress = user.profile;
        if (!primaryAddress) {
            console.warn('User profile not found, creating fallback');
            primaryAddress = {
                name: user.name || 'User',
                phone: user.phone || '',
                address: 'Alamat tidak tersedia'
            };
        }
        console.log('✓ Using user profile as address:', primaryAddress);
        
        // Fetch cart items details
        let products = [];
        
        console.log(`Processing ${cart.length} items from cart`);
        
        // Process each cart item
        for (const item of cart) {
            try {
                console.log(`Fetching product ${item.id} with quantity ${item.quantity}`);
                
                const prodRes = await fetch(`${API_URL}/products/${item.id}`, {
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!prodRes.ok) {
                    console.error(`Failed to fetch product ${item.id}: ${prodRes.status} ${prodRes.statusText}`);
                    // Add fallback product from cart data
                    products.push({
                        id: item.id,
                        name: `Produk #${item.id}`,
                        price: 0,
                        quantity: item.quantity || 1,
                        image_url: ''
                    });
                    continue;
                }
                
                const prodData = await prodRes.json();
                const product = prodData.data || prodData;
                
                if (product && product.id) {
                    const productObj = {
                        id: product.id,
                        name: product.name || 'Unknown',
                        price: product.price || 0,
                        quantity: item.quantity || 1,
                        image_url: (product.image_urls && product.image_urls[0]) || product.image || ''
                    };
                    products.push(productObj);
                    console.log(`✓ Added product: ${productObj.name} (qty: ${productObj.quantity})`);
                } else {
                    console.error(`Product data invalid for ${item.id}:`, product);
                    // Add fallback
                    products.push({
                        id: item.id,
                        name: `Produk #${item.id}`,
                        price: 0,
                        quantity: item.quantity || 1,
                        image_url: ''
                    });
                }
            } catch (prodErr) {
                console.error(`Error fetching product ${item.id}:`, prodErr.message);
                // Add fallback even on error
                products.push({
                    id: item.id,
                    name: `Produk #${item.id}`,
                    price: 0,
                    quantity: item.quantity || 1,
                    image_url: ''
                });
            }
        }
        
        console.log(`Total products fetched: ${products.length}`, products);
        
        paymentState.cart = cart;
        paymentState.products = products;
        
        // Update UI
        console.log('Using address for display:', primaryAddress);
        
        try {
            updateAddressDisplay(primaryAddress);
        } catch (err) {
            console.error('Error updating address display:', err);
        }
        
        try {
            updateCartDisplayWithControls(products);
        } catch (err) {
            console.error('Error updating cart display:', err);
        }
        
        try {
            const totals = calculateTotals();
            updateSummaryDisplay(totals);
        } catch (err) {
            console.error('Error updating summary display:', err);
        }
        
        try {
            updateUserAvatar(user);
        } catch (err) {
            console.error('Error updating avatar:', err);
        }
        
        console.log('✓ All UI updated successfully');
        
        // Setup payment button
        try {
            setupPaymentButton();
        } catch (err) {
            console.error('Error setting up payment button:', err);
        }
        
        // Setup shipping and payment UI
        try {
            setupShippingMethodUI();
        } catch (err) {
            console.error('Error setting up shipping UI:', err);
        }
        
        try {
            setupPaymentMethodUI();
        } catch (err) {
            console.error('Error setting up payment method UI:', err);
        }
        
        console.log('✓ Payment page fully loaded!');
        
    } catch (err) {
        console.error('=== CRITICAL ERROR ===');
        console.error('Error loading payment data:', err);
        console.error('Error message:', err.message);
        console.error('Error stack:', err.stack);
        alert('Gagal memuat data pembayaran: ' + err.message);
    }
}

// Setup payment button
function setupPaymentButton() {
    const payBtn = document.querySelector('button[class*="bg-primary"]');
    
    if (payBtn) {
        payBtn.setAttribute('type', 'button');
        payBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const token = localStorage.getItem('token');
            const totals = calculateTotals();
            
            if (!paymentState.userData) {
                alert('Data user tidak ditemukan');
                return;
            }
            
            try {
                // Get selected payment method
                const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value || 'bca';
                
                // Get shipping address from user profile
                let shippingAddress = 'Alamat tidak tersedia';
                if (paymentState.userData) {
                    const profile = paymentState.userData.profile || paymentState.userData;
                    shippingAddress = profile.full_address || profile.address || 'Alamat tidak tersedia';
                }
                
                // Create order
                const orderItems = paymentState.products.map(prod => ({
                    product_id: prod.id,
                    quantity: prod.quantity,
                    price: prod.price
                }));
                
                const res = await fetch(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        items: orderItems,
                        shipping_address: shippingAddress,
                        subtotal: totals.subtotal,
                        shipping_cost: totals.shippingCost,
                        total: totals.total,
                        payment_method: paymentMethod
                    })
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.message || 'Gagal membuat order');
                }
                
                const orderData = await res.json();
                
                // Clear cart
                localStorage.removeItem('cart');
                sessionStorage.removeItem('cartTotal');
                
                alert('Order berhasil dibuat! Terima kasih telah berbelanja.');
                
                // Redirect ke halaman beranda
                setTimeout(() => {
                    window.location.href = 'Halaman.beranda.html';
                }, 1500);
                
            } catch (err) {
                alert('Error: ' + err.message);
                console.error(err);
            }
        });
    }
}

// Setup Navigation
function setupNavigation() {
    // Logo
    const logoBtn = document.querySelector('a.flex.items-center');
    if (logoBtn) {
        logoBtn.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = 'Halaman.beranda.html';
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = 'login.html';
        return;
    }
    
    loadPaymentData();
    setupNavigation();
});
</script>

</body></html>
<!DOCTYPE html>

<html class="light" lang="id"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Roasty - Checkout</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<div id="midtrans-script-container"></div>
<script src="config.js"></script>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#f26c0d",
                        "primary-hover": "#d95a00",
                        "background-light": "#f8f7f5",
                        "background-dark": "#221710",
                        "surface-light": "#ffffff",
                        "surface-dark": "#2d2018",
                        "text-main-light": "#1c130d",
                        "text-main-dark": "#f4ece7",
                        "text-sec-light": "#9c6c49",
                        "text-sec-dark": "#d6bba9",
                        "border-light": "#e8d9ce",
                        "border-dark": "#4a3b32",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
<style>
    /* Shipping method animation */
    label[name="shipping"] {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    label[name="shipping"].active {
        transform: scale(1.02);
    }

    /* Payment method animation */
    .payment-method-item {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .payment-method-item.active {
        box-shadow: 0 4px 12px rgba(242, 108, 13, 0.25);
    }

    /* Quantity control animation */
    .qty-minus, .qty-plus {
        transition: all 0.2s ease;
    }

    .qty-minus:active, .qty-plus:active {
        transform: scale(0.95);
    }

    /* Content expand animation for payment methods */
    [class*="border-t"] {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        max-height: 0;
        overflow: hidden;
        opacity: 0;
    }

    [class*="border-t"].active {
        max-height: 300px;
        opacity: 1;
        overflow: visible;
    }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark text-text-main-light dark:text-text-main-dark font-display antialiased min-h-screen flex flex-col">
<header class="sticky top-0 z-50 bg-surface-light dark:bg-surface-dark border-b border-border-light dark:border-border-dark px-4 md:px-10 py-3 shadow-sm">
<div class="max-w-[1280px] mx-auto flex items-center justify-between">
<div class="flex items-center gap-2">
<a class="flex items-center gap-2 text-primary hover:opacity-80 transition-opacity" href="#">
<span class="material-symbols-outlined text-3xl">local_cafe</span>
<h2 class="text-xl font-bold tracking-tight text-text-main-light dark:text-text-main-dark">Roasty</h2>
</a>
<div class="hidden md:flex items-center gap-1 ml-6 px-3 py-1 rounded-full bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 text-xs font-bold border border-green-200 dark:border-green-800">
<span class="material-symbols-outlined text-[16px]">lock</span>
<span>Pembayaran Aman</span>
</div>
</div>
<div class="flex items-center gap-6">
<a id="admin-button" href="admin_dashboard.html" class="hidden items-center gap-2 px-4 py-2 bg-gradient-to-r from-orange-500 to-orange-600 dark:from-orange-600 dark:to-orange-700 text-white rounded-lg hover:shadow-lg transition-all text-sm font-semibold whitespace-nowrap">
<span class="material-symbols-outlined text-lg">admin_panel_settings</span>
<span class="hidden md:inline">Admin Panel</span>
</a>

<div id="user-icons" class="flex items-center gap-3">
<button id="cart-button" class="hidden relative p-2 text-text-main-light dark:text-text-main-dark hover:opacity-70 rounded-lg transition-opacity">
<span class="material-symbols-outlined">shopping_cart</span>
<span id="cart-badge" class="absolute top-1 right-1 h-5 w-5 bg-primary text-white text-xs rounded-full flex items-center justify-center font-bold hidden">0</span>
</button>

<button id="notification-button" class="hidden p-2 text-text-main-light dark:text-text-main-dark hover:opacity-70 rounded-lg transition-opacity">
<span class="material-symbols-outlined">notifications</span>
<span id="notification-badge" class="absolute top-1 right-1 h-2 w-2 bg-primary rounded-full hidden"></span>
</button>
</div>

<button id="profile-button" class="flex items-center gap-2 pl-3 py-1 rounded-full hover:opacity-80 transition-opacity">
<div class="w-8 h-8 rounded-full bg-cover bg-center border border-border-light dark:border-border-dark" id="profile-avatar" data-alt="User profile picture">
</div>
<span class="text-sm font-medium hidden sm:block" id="profile-name">User</span>
</button>
</div>

</div>
</div>
</header>
<main class="flex-grow w-full max-w-[1280px] mx-auto px-4 md:px-10 py-8">
<h1 class="text-2xl font-bold mb-6 text-text-main-light dark:text-text-main-dark">Checkout</h1>
<div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
<div class="lg:col-span-8 space-y-6">
<section>
<div class="flex items-center justify-between mb-3">
<h2 class="text-lg font-bold">Alamat Pengiriman</h2>
</div>
<div class="relative overflow-hidden rounded-xl shadow-sm group">
<div class="absolute inset-0 bg-cover bg-center" data-alt="Abstract map pattern background orange gradient" style='background-image: linear-gradient(135deg, rgba(34, 23, 16, 0.7) 0%, rgba(34, 23, 16, 0.4) 100%), url("https://lh3.googleusercontent.com/aida-public/AB6AXuCiymvwf5yjnVgrArPzw16Ko3oQ3qDH_0q7gHV_aGDBzsty-5jUpVVbIAc9-87D-Jee0Ufj343ghLtCoacbhklldBtctVzrRFO4jXZ_qrz_r3dp7fhjnRXNZ7kDRjTyW3yJOhc7RSkyDUick1S3VBtJ7tgY8DCM8LptgtWeaheecqCkHJWrl7mELqOsNr5FjUaDorVcjRk1szfeDs2nK23IqyirSQML_XvQQFyQ4Yj6F1LYE8FWcYZQ-uWgVFjjR2S-88v30bMoCw");'>
</div>
<div class="relative p-6 flex flex-col sm:flex-row items-start sm:items-end justify-between gap-4">
<div class="flex-1 text-white">
<div class="flex items-center gap-2 mb-2">
<span class="material-symbols-outlined text-primary">location_on</span>
<span class="bg-primary/90 text-white text-xs px-2 py-0.5 rounded font-bold">Utama</span>
</div>
<h3 class="text-xl font-bold leading-tight mb-1">Kantor - Budi Santoso</h3>
<p class="text-white/90 text-sm leading-relaxed">+62 812-3456-7890</p>
<p class="text-white/90 text-sm leading-relaxed max-w-lg">
                                    Gedung Menara Karya, Lantai 15, Jl. H. R. Rasuna Said Blok X-5, Kuningan, Jakarta Selatan, 12950
                                </p>
</div>
<button class="bg-surface-light hover:bg-gray-50 text-text-main-light font-bold py-2 px-4 rounded-lg text-sm transition-colors shadow-sm flex items-center gap-2 whitespace-nowrap">
<span>Ubah Alamat</span>
</button>
</div>
<div class="absolute top-0 left-0 w-1 h-full bg-primary"></div>
</div>
</section>
<section class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark p-6 shadow-sm">
<h2 class="text-lg font-bold mb-4 flex items-center gap-2">
<span class="material-symbols-outlined text-primary">inventory_2</span>
                        Pesanan Anda
                    </h2>
<div class="flex items-center gap-2 mb-4 pb-3 border-b border-border-light dark:border-border-dark">
<span class="material-symbols-outlined text-text-sec-light dark:text-text-sec-dark text-lg">storefront</span>
<span class="font-bold text-sm">Roasty Official Store</span>
<span class="bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 text-[10px] px-1.5 py-0.5 rounded font-bold uppercase">Official</span>
</div>
<div class="w-full">
<table class="w-full">
<thead>
<tr class="text-left text-xs text-text-sec-light dark:text-text-sec-dark border-b border-dashed border-border-light dark:border-border-dark">
<th class="pb-2 font-medium w-16">Produk</th>
<th class="pb-2 font-medium">Detail</th>
<th class="pb-2 font-medium text-right hidden sm:table-cell">Harga Satuan</th>
<th class="pb-2 font-medium text-right">Jumlah</th>
<th class="pb-2 font-medium text-right w-24">Total</th>
</tr>
</thead>
<tbody class="divide-y divide-border-light dark:divide-border-dark" id="cartItemsTable">
</tbody>
</table>
</div>
</section>
<section class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark p-6 shadow-sm">
<h2 class="text-lg font-bold mb-4 flex items-center gap-2">
<span class="material-symbols-outlined text-primary">local_shipping</span>
                        Pengiriman
                    </h2>
<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
<label class="relative flex cursor-pointer rounded-lg border-2 border-primary bg-primary/5 p-4 shadow-sm focus:outline-none">
<input checked="" class="sr-only" name="delivery-method" type="radio" value="reguler"/>
<span class="flex flex-1">
<span class="flex flex-col">
<span class="block text-sm font-bold text-text-main-light dark:text-text-main-dark">Reguler (JNE/J&T)</span>
<span class="mt-1 flex items-center text-xs text-text-sec-light dark:text-text-sec-dark">Est. 2-3 Hari</span>
<span class="mt-2 text-sm font-bold text-primary">Rp 15.000</span>
</span>
</span>
<span class="material-symbols-outlined text-primary" data-fill="1" data-icon="check_circle">check_circle</span>
</label>
<label class="relative flex cursor-pointer rounded-lg border border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark p-4 shadow-sm hover:border-gray-300 dark:hover:border-gray-600 focus:outline-none">
<input class="sr-only" name="delivery-method" type="radio" value="nextday"/>
<span class="flex flex-1">
<span class="flex flex-col">
<span class="block text-sm font-bold text-text-main-light dark:text-text-main-dark">Next Day (SiCepat)</span>
<span class="mt-1 flex items-center text-xs text-text-sec-light dark:text-text-sec-dark">Est. 1 Hari</span>
<span class="mt-2 text-sm font-bold text-text-main-light dark:text-text-main-dark">Rp 28.000</span>
</span>
</span>
<span class="material-symbols-outlined text-gray-300">circle</span>
</label>
<label class="relative flex cursor-pointer rounded-lg border border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark p-4 shadow-sm hover:border-gray-300 dark:hover:border-gray-600 focus:outline-none">
<input class="sr-only" name="delivery-method" type="radio" value="instant"/>
<span class="flex flex-1">
<span class="flex flex-col">
<span class="block text-sm font-bold text-text-main-light dark:text-text-main-dark">Instant (Gojek/Grab)</span>
<span class="mt-1 flex items-center text-xs text-text-sec-light dark:text-text-sec-dark">Est. 3-6 Jam</span>
<span class="mt-2 text-sm font-bold text-text-main-light dark:text-text-main-dark">Rp 45.000</span>
</span>
</span>
<span class="material-symbols-outlined text-gray-300">circle</span>
</label>
</div>
</section>
<section class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark p-6 shadow-sm">
<h2 class="text-lg font-bold mb-4 flex items-center gap-2">
<span class="material-symbols-outlined text-primary">payments</span>
                        Metode Pembayaran
                    </h2>
<div class="space-y-3" id="paymentMethods">
<div class="text-center py-4 text-gray-500">
<p class="animate-pulse">‚è≥ Memuat metode pembayaran...</p>
</div>
</div>
</section>
</div>
<div class="lg:col-span-4 relative">
<div class="sticky top-24 flex flex-col gap-4">
<div class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark p-4 shadow-sm">
<label class="block text-sm font-bold mb-2 text-text-main-light dark:text-text-main-dark flex items-center gap-2">
<span class="material-symbols-outlined text-primary text-lg">confirmation_number</span>
                            Kode Promo & Diskon
                        </label>
<div class="flex gap-2">
<input class="flex-1 rounded-lg border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark text-sm focus:ring-primary focus:border-primary" placeholder="Masukkan kode" type="text"/>
<button class="bg-gray-200 dark:bg-gray-700 text-text-main-light dark:text-text-main-dark font-bold px-4 py-2 rounded-lg text-sm hover:bg-gray-300 dark:hover:bg-gray-600">Pakai</button>
</div>
</div>
<div class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark p-6 shadow-lg shadow-gray-200/50 dark:shadow-none">
<h3 class="text-lg font-bold mb-5 pb-3 border-b border-border-light dark:border-border-dark">Ringkasan Belanja</h3>
<div class="space-y-3 mb-6">
<div class="flex justify-between text-sm">
<span class="text-text-sec-light dark:text-text-sec-dark">Total Harga (3 Barang)</span>
<span class="font-medium">Rp 230.000</span>
</div>
<div class="flex justify-between text-sm">
<span class="text-text-sec-light dark:text-text-sec-dark">Total Ongkos Kirim</span>
<span class="font-medium">Rp 15.000</span>
</div>
<div class="flex justify-between text-sm">
<span class="text-text-sec-light dark:text-text-sec-dark">Biaya Asuransi</span>
<span class="font-medium">Rp 2.000</span>
</div>
<div class="flex justify-between text-sm">
<span class="text-text-sec-light dark:text-text-sec-dark">Biaya Layanan</span>
<span class="font-medium">Rp 1.000</span>
</div>
<div class="flex justify-between text-sm text-primary">
<span class="font-medium">Diskon Ongkir</span>
<span class="font-bold">-Rp 10.000</span>
</div>
</div>
<div class="border-t border-dashed border-border-light dark:border-border-dark pt-4 mb-6">
<div class="flex justify-between items-center mb-1">
<span class="text-base font-bold text-text-main-light dark:text-text-main-dark">Total Tagihan</span>
<span class="text-xl font-bold text-primary">Rp 238.000</span>
</div>
<p class="text-xs text-text-sec-light dark:text-text-sec-dark text-right">Termasuk PPN jika berlaku</p>
</div>
<div class="mb-6 p-4 bg-primary/10 rounded-lg border border-primary/30">
<p class="text-xs text-text-sec-light dark:text-text-sec-dark mb-2">TOTAL HARGA</p>
<p class="text-2xl font-bold text-primary">Rp 238.000</p>
</div>
<button id="paymentButton" class="w-full bg-primary hover:bg-primary-hover text-white font-bold py-3.5 px-4 rounded-xl shadow-lg shadow-primary/30 transition-all transform active:scale-[0.98] flex items-center justify-center gap-2">
<span class="material-symbols-outlined">lock</span>
                            Bayar Sekarang
                        </button>
<div class="mt-4 flex items-center justify-center gap-2 text-xs text-text-sec-light dark:text-text-sec-dark">
<span class="material-symbols-outlined text-sm">verified_user</span>
<span>Transaksi ini dilindungi dan aman.</span>
</div>
</div>
</div>
</div>
</div>
</main>
<footer class="mt-12 bg-surface-light dark:bg-surface-dark border-t border-border-light dark:border-border-dark py-8 text-center">
<p class="text-sm text-text-sec-light dark:text-text-sec-dark mb-2">¬© 2023 Roasty Marketplace. All rights reserved.</p>
<div class="flex justify-center gap-4 text-xs text-text-sec-light dark:text-text-sec-dark">
<a class="hover:text-primary" href="#">Syarat & Ketentuan</a>
<a class="hover:text-primary" href="#">Kebijakan Privasi</a>
<a class="hover:text-primary" href="#">Bantuan</a>
</div>
</footer>

<script src="navbar-helper.js"></script>
<script>
const API_URL = CONFIG.API_BASE_URL;
const ASSETS_URL = CONFIG.assets;
let paymentState = {
    cart: [],
    products: [],
    userData: null,
    shippingCost: 15000,
    insuranceCost: 2000,
    serviceCost: 1000,
    discount: 0
};

// Normalize image URL to use proper asset base URL
function normalizeImageUrl(imageUrl) {
    if (!imageUrl) return 'https://via.placeholder.com/64';

    // If it's already a full http/https URL with localhost, convert it
    if (imageUrl.includes('localhost:8000') || imageUrl.includes('127.0.0.1')) {
        // Extract the path after /storage
        const match = imageUrl.match(/\/storage\/(.*)/);
        if (match) {
            return `${ASSETS_URL}/${match[1]}`;
        }
    }

    // If it's already a full URL, return as is
    if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) {
        return imageUrl;
    }

    // If it's a relative path, prepend assets URL
    return `${ASSETS_URL}/${imageUrl}`;
}

// ============================================
// FUNGSI UNTUK LOAD MIDTRANS SCRIPT DINAMIS
// ============================================
/**
 * Load Midtrans script dengan client key dari backend
 * Dengan retry logic dan better error handling
 */
async function loadMidtransScript() {
    // Jika sudah ada window.snap, return langsung
    if (window.snap) {
        console.log('‚úì Midtrans script sudah tersedia');
        return true;
    }

    console.log('Mengambil Midtrans config...');

    // Ambil Client Key (Prioritaskan dari CONFIG.js karena kita pakai Ngrok/Fix)
    let clientKey = CONFIG.MIDTRANS_CLIENT_KEY;

    // Fallback: Jika tidak ada di config, coba ambil dari backend (opsional)
    if (!clientKey) {
        try {
            const response = await fetch(`${API_URL}/midtrans-config`);
            const data = await response.json();
            clientKey = data.data?.client_key;
        } catch (e) {
            console.warn("Gagal fetch config dari backend");
        }
    }

    if (!clientKey) {
        alert("Client Key Midtrans tidak ditemukan. Cek config.js");
        return false;
    }

    // Load Midtrans script
    return new Promise((resolve, reject) => {
        try {
            console.log('Memuat Midtrans Snap script (Forced Sandbox)...');

            const script = document.createElement('script');
            // PERUBAHAN UTAMA DISINI:
            // Kita MEMAKSA URL Sandbox karena akun Anda Sandbox tapi Key-nya format Production.
            // URL Production (app.midtrans.com) akan menolak token sandbox Anda (Error 404).
            script.src = 'https://app.sandbox.midtrans.com/snap/snap.js';

            script.setAttribute('data-client-key', clientKey);

            script.onload = () => {
                console.log('‚úì Midtrans script loaded');

                // Tunggu window.snap tersedia
                let snapReady = false;
                let attempts = 0;
                const checkSnap = setInterval(() => {
                    attempts++;
                    if (window.snap && typeof window.snap.pay === 'function') {
                        clearInterval(checkSnap);
                        snapReady = true;
                        console.log('‚úì window.snap siap digunakan');
                        resolve(true);
                    } else if (attempts > 20) {
                        clearInterval(checkSnap);
                        console.warn('‚ö†Ô∏è window.snap belum siap setelah 2 detik');
                        resolve(true); // Resolve anyway, snap mungkin loading di background
                    }
                }, 100);
            };

            script.onerror = () => {
                console.error('‚úó Gagal load Midtrans Snap script');
                reject(new Error('Gagal memuat Midtrans Snap script dari CDN'));
            };

            document.head.appendChild(script);

        } catch (err) {
            console.error('‚ùå Error setting up Midtrans script:', err.message);
            reject(err);
        }
    });
}

// Format currency
function formatCurrency(amount) {
    return 'Rp ' + parseInt(amount).toLocaleString('id-ID');
}

// Calculate totals
function calculateTotals() {
    const subtotal = paymentState.products.reduce((sum, prod) => sum + (prod.price * prod.quantity), 0);
    const total = subtotal + paymentState.shippingCost + paymentState.insuranceCost + paymentState.serviceCost - paymentState.discount;

    return {
        subtotal,
        shippingCost: paymentState.shippingCost,
        insuranceCost: paymentState.insuranceCost,
        serviceCost: paymentState.serviceCost,
        discount: paymentState.discount,
        total
    };
}

// Update address display
function updateAddressDisplay(userData) {
    const addressCard = document.querySelector('div.relative.overflow-hidden.rounded-xl');
    if (!addressCard) {
        console.warn('Address card not found in DOM');
        return;
    }

    if (!userData) {
        console.warn('No user data provided');
        return;
    }

    // Coba ambil dari berbagai struktur data yang mungkin
    let fullName = 'User';
    let phone = '+62 8xx xxxx xxxx';
    let address = 'Alamat tidak tersedia';

    // Priority 1: Dari user.primary_address (UserAddress model)
    if (userData.primary_address) {
        const addr = userData.primary_address;
        console.log('üìç Using primary_address:', addr);
        fullName = addr.recipient_name || addr.name || userData.name || 'User';
        phone = addr.phone || userData.phone || phone;
        address = addr.alamat || addr.address || 'Alamat tidak tersedia';
    }
    // Priority 2: Dari user.address (UserAddress model)
    else if (userData.address) {
        const addr = userData.address;
        console.log('üìç Using address:', addr);
        fullName = addr.recipient_name || addr.name || userData.name || 'User';
        phone = addr.phone || userData.phone || phone;
        address = addr.alamat || addr.address || 'Alamat tidak tersedia';
    }
    // Priority 3: Dari user.profile (Profile model)
    else if (userData.profile) {
        const profile = userData.profile;
        console.log('üìç Using profile:', profile);
        fullName = profile.user?.name || profile.name || userData.name || 'User';
        phone = profile.phone_number || profile.phone || userData.phone || phone;
        address = profile.full_address || profile.address || 'Alamat tidak tersedia';
    }
    // Priority 4: Direct properties di userData
    else {
        console.log('üìç Using direct userData properties');
        fullName = userData.name || fullName;
        phone = userData.phone_number || userData.phone || phone;
        address = userData.full_address || userData.address || address;
    }

    console.log('‚úÖ Updating address display:', { fullName, phone, address });

    // Get all paragraph elements inside address card
    const paragraphs = addressCard.querySelectorAll('p.text-white\\/90');

    // Update name
    const nameEl = addressCard.querySelector('h3.text-xl.font-bold');
    if (nameEl) {
        nameEl.textContent = fullName;
        console.log('‚úì Name updated:', fullName);
    }

    // Update phone - paragraphs[0] adalah phone (first p dengan class text-white/90)
    if (paragraphs.length > 0) {
        paragraphs[0].textContent = phone;
        console.log('‚úì Phone updated:', phone);
    }

    // Update address - paragraphs[1] adalah address (second p dengan class text-white/90 dan max-w-lg)
    if (paragraphs.length > 1) {
        paragraphs[1].textContent = address;
        console.log('‚úì Address updated:', address);
    }

    // Store address untuk dipakai saat pembayaran
    paymentState.shippingAddress = address;
    paymentState.shippingPhone = phone;
}

// Update summary display
function updateSummaryDisplay(totals) {
    const summaryContainer = document.querySelector('div.bg-surface-light.rounded-xl.border.border-border-light.dark\\:bg-surface-dark.dark\\:border-border-dark.p-6.shadow-lg');
    if (!summaryContainer) return;

    const itemCount = paymentState.products.reduce((sum, p) => sum + p.quantity, 0);

    // Update summary items
    const summaryText = summaryContainer.querySelector('div.space-y-3.mb-6');
    if (summaryText) {
        summaryText.innerHTML = `
            <div class="flex justify-between text-sm">
                <span class="text-text-sec-light dark:text-text-sec-dark">Total Harga (${itemCount} Barang)</span>
                <span class="font-medium">${formatCurrency(totals.subtotal)}</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-text-sec-light dark:text-text-sec-dark">Total Ongkos Kirim</span>
                <span class="font-medium">${formatCurrency(totals.shippingCost)}</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-text-sec-light dark:text-text-sec-dark">Biaya Asuransi</span>
                <span class="font-medium">${formatCurrency(totals.insuranceCost)}</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-text-sec-light dark:text-text-sec-dark">Biaya Layanan</span>
                <span class="font-medium">${formatCurrency(totals.serviceCost)}</span>
            </div>
            ${totals.discount > 0 ? `
                <div class="flex justify-between text-sm text-primary">
                    <span class="font-medium">Diskon Ongkir</span>
                    <span class="font-bold">-${formatCurrency(totals.discount)}</span>
                </div>
            ` : ''}
        `;
    }

    // Update total tagihan
    const totalEl = summaryContainer.querySelector('span.text-xl.font-bold.text-primary');
    if (totalEl) {
        totalEl.textContent = formatCurrency(totals.total);
    }

    // Update total harga display (new section above button)
    const totalHargaSection = summaryContainer.querySelector('div.bg-primary\\/10.rounded-lg.border.border-primary\\/30');
    if (totalHargaSection) {
        const totalHargaEl = totalHargaSection.querySelector('p.text-2xl.font-bold.text-primary');
        if (totalHargaEl) {
            totalHargaEl.textContent = formatCurrency(totals.total);
        }
    }
}

// Update cart items display

// Update cart items with quantity controls
function updateCartDisplayWithControls(products) {
    const tableBody = document.getElementById('cartItemsTable');
    if (!tableBody) {
        console.error('Cart table body not found!');
        return;
    }

    console.log('Updating cart display with products:', products);
    tableBody.innerHTML = '';

    if (products.length === 0) {
        console.warn('No products to display!');
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Tidak ada barang di keranjang</td></tr>';
        return;
    }

    products.forEach((product, index) => {
        const row = document.createElement('tr');
        const itemTotal = product.price * product.quantity;
        const normalizedImageUrl = normalizeImageUrl(product.image_url);

        row.innerHTML = `
            <td class="py-4 align-top">
                <div class="size-16 rounded-lg bg-gray-100 dark:bg-gray-800 bg-cover bg-center border border-border-light dark:border-border-dark" style="background-image: url('${normalizedImageUrl}');"></div>
            </td>
            <td class="py-4 px-3 align-top">
                <p class="font-bold text-sm text-text-main-light dark:text-text-main-dark line-clamp-2">${product.name}</p>
                <p class="text-xs text-text-sec-light dark:text-text-sec-dark mt-1">Stok: Tersedia</p>
            </td>
            <td class="py-4 align-top text-right hidden sm:table-cell">
                <p class="text-sm font-medium">${formatCurrency(product.price)}</p>
            </td>
            <td class="py-4 align-top text-right">
                <div class="flex items-center gap-2 justify-end">
                    <button class="qty-minus size-8 flex items-center justify-center bg-gray-100 dark:bg-gray-800 rounded border border-border-light dark:border-border-dark hover:bg-primary hover:text-white transition-all duration-200" data-index="${index}">
                        <span class="material-symbols-outlined text-lg">remove</span>
                    </button>
                    <span class="qty-display w-8 text-center font-medium">${product.quantity}</span>
                    <button class="qty-plus size-8 flex items-center justify-center bg-gray-100 dark:bg-gray-800 rounded border border-border-light dark:border-border-dark hover:bg-primary hover:text-white transition-all duration-200" data-index="${index}">
                        <span class="material-symbols-outlined text-lg">add</span>
                    </button>
                </div>
            </td>
            <td class="py-4 align-top text-right">
                <p class="text-sm font-bold text-primary item-total">${formatCurrency(itemTotal)}</p>
            </td>
        `;

        tableBody.appendChild(row);
        console.log(`Added product ${product.id} (${product.name}) with quantity ${product.quantity}`);

        // Setup quantity controls
        const minusBtn = row.querySelector('.qty-minus');
        const plusBtn = row.querySelector('.qty-plus');

        if (!minusBtn || !plusBtn) {
            console.error('Buttons not found for product:', product);
            return;
        }

        minusBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (product.quantity > 1) {
                product.quantity--;
                console.log(`Decreased quantity for ${product.name} to ${product.quantity}`);
                const totals = calculateTotals();
                updateSummaryDisplay(totals);
                updateCartDisplayWithControls(paymentState.products);
            }
        });

        plusBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            product.quantity++;
            console.log(`Increased quantity for ${product.name} to ${product.quantity}`);
            const totals = calculateTotals();
            updateSummaryDisplay(totals);
            updateCartDisplayWithControls(paymentState.products);
        });
    });

    console.log('Cart display updated with', products.length, 'items');
}

// Update user avatar
function updateUserAvatar(userData) {
    try {
        const avatarEl = document.querySelector('div.bg-center.bg-no-repeat.bg-cover.rounded-full.size-9');
        if (!avatarEl) {
            console.warn('Avatar element not found');
            return;
        }

        if (userData && userData.profile_image) {
            avatarEl.style.backgroundImage = `url('${userData.profile_image}')`;
            console.log('‚úì Avatar updated');
        } else {
            console.warn('No profile image found in user data');
        }
    } catch (err) {
        console.error('Error updating avatar:', err);
    }
}

// Setup shipping method UI with animations
function setupShippingMethodUI() {
    // Find all shipping radios directly
    const shippingRadios = document.querySelectorAll('input[name="delivery-method"]');
    if (shippingRadios.length === 0) return;

    shippingRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            // Update all labels
            shippingRadios.forEach(r => {
                const label = r.closest('label');
                if (!label) return;

                if (r === radio) {
                    // Selected label
                    label.classList.remove('border-border-light', 'dark:border-border-dark', 'bg-surface-light', 'dark:bg-surface-dark');
                    label.classList.add('border-primary', 'bg-primary/5');

                    // Update icon
                    const icon = label.querySelector('.material-symbols-outlined');
                    if (icon) {
                        icon.textContent = 'check_circle';
                        icon.classList.remove('text-gray-300');
                        icon.classList.add('text-primary');
                    }
                } else {
                    // Unselected labels
                    label.classList.remove('border-primary', 'bg-primary/5');
                    label.classList.add('border-border-light', 'dark:border-border-dark', 'bg-surface-light', 'dark:bg-surface-dark');

                    // Update icon
                    const icon = label.querySelector('.material-symbols-outlined');
                    if (icon) {
                        icon.textContent = 'circle';
                        icon.classList.remove('text-primary');
                        icon.classList.add('text-gray-300');
                    }
                }
            });

            // Update shipping cost
            if (this.value === 'reguler') {
                paymentState.shippingCost = 15000;
            } else if (this.value === 'nextday') {
                paymentState.shippingCost = 28000;
            } else if (this.value === 'instant') {
                paymentState.shippingCost = 45000;
            }

            const totals = calculateTotals();
            updateSummaryDisplay(totals);
        });
    });
}

// Setup payment method UI with animations
function setupPaymentMethodUI() {
    const paymentRadios = document.querySelectorAll('input[name="payment"]');
    if (paymentRadios.length === 0) return;

    paymentRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            // Update all payment containers
            paymentRadios.forEach(r => {
                const container = r.closest('.rounded-lg.border');
                if (!container) return;

                const label = container.querySelector('label');
                const content = container.querySelector('[class*="border-t"]');

                if (r === radio) {
                    // Selected payment method
                    if (label) {
                        label.classList.add('border-primary', 'bg-primary/5', 'shadow-md');
                        label.classList.remove('hover:bg-gray-50', 'dark:hover:bg-gray-800/50');
                    }

                    // Show content with animation
                    if (content) {
                        setTimeout(() => {
                            content.style.maxHeight = '300px';
                            content.style.opacity = '1';
                            content.style.overflow = 'visible';
                        }, 10);
                    }
                } else {
                    // Unselected payment methods
                    if (label) {
                        label.classList.remove('border-primary', 'bg-primary/5', 'shadow-md');
                        label.classList.add('hover:bg-gray-50', 'dark:hover:bg-gray-800/50');
                    }

                    // Hide content with animation
                    if (content) {
                        content.style.maxHeight = '0';
                        content.style.opacity = '0';
                        content.style.overflow = 'hidden';
                    }
                }
            });
        });
    });
}

// Load Midtrans payment methods
async function loadPaymentMethods() {
    const container = document.getElementById('paymentMethods');
    if (!container) return;

    try {
        // Midtrans payment methods - yang sudah tested dan stabil
        const methods = [
            {
                id: 'gopay',
                name: 'GoPay',
                icon: 'üì±',
                description: 'Scan QRIS atau Tap'
            },
            {
                id: 'bca_va',
                name: 'BCA Virtual Account',
                icon: 'üè¶',
                description: 'Transfer ke Virtual Account BCA'
            },
            {
                id: 'bni_va',
                name: 'BNI Virtual Account',
                icon: 'üè¶',
                description: 'Transfer ke Virtual Account BNI'
            },
            {
                id: 'mandiri_va',
                name: 'Mandiri Virtual Account',
                icon: 'üè¶',
                description: 'Transfer ke Virtual Account Mandiri'
            },
            {
                id: 'permata_va',
                name: 'Permata Virtual Account',
                icon: 'üè¶',
                description: 'Transfer ke Virtual Account Permata'
            },
            {
                id: 'credit_card',
                name: 'Kartu Kredit',
                icon: 'üí≥',
                description: 'Visa, Mastercard, atau Amex'
            }
        ];

        container.innerHTML = methods.map((method, index) => `
            <div class="rounded-lg border border-border-light dark:border-border-dark overflow-hidden payment-method-item">
                <label class="flex items-center p-4 cursor-pointer bg-surface-light dark:bg-surface-dark hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all">
                    <input
                        ${index === 0 ? 'checked' : ''}
                        class="size-4 border-gray-300 text-primary focus:ring-primary"
                        name="payment"
                        value="${method.id}"
                        type="radio"
                    />
                    <div class="ml-3 flex items-center justify-between flex-1">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">${method.icon}</div>
                            <div>
                                <span class="block text-sm font-medium text-text-main-light dark:text-text-main-dark">${method.name}</span>
                                <span class="text-xs text-text-sec-light dark:text-text-sec-dark">${method.description}</span>
                            </div>
                        </div>
                    </div>
                </label>
            </div>
        `).join('');

        console.log('‚úì Payment methods loaded');
        setupPaymentMethodUI();
    } catch (err) {
        console.error('Error loading payment methods:', err);
        container.innerHTML = '<div class="text-red-500">Gagal memuat metode pembayaran</div>';
    }
}

// Load payment data
async function loadPaymentData() {
    const rawCart = localStorage.getItem('cart');
    const cart = JSON.parse(rawCart || '[]');
    const token = localStorage.getItem('token');

    if (!token) {
        alert('Silakan login terlebih dahulu');
        window.location.href = 'login.html';
        return;
    }

    if (cart.length === 0) {
        alert('Keranjang kosong');
        window.location.href = 'halaman.keranjang.belanja.html';
        return;
    }

    try {
        console.log('Loading payment data...');

        // Fetch user data
        let user = null;
        try {
            const userRes = await fetch(`${API_URL}/me`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            });

            if (userRes.ok) {
                const userData = await userRes.json();
                user = userData.data || userData;
            } else if (userRes.status === 401) {
                localStorage.removeItem('token');
                alert('Sesi Anda telah berakhir. Silakan login kembali.');
                window.location.href = 'login.html';
                return;
            }
        } catch (err) {
            console.warn('Fetch /me failed, using fallback:', err.message);
        }

        // Fetch primary address (alamat utama)
        if (user && user.id) {
            try {
                const addressRes = await fetch(`${API_URL}/user-addresses`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });

                if (addressRes.ok) {
                    const addressData = await addressRes.json();
                    const addresses = addressData.data || [];
                    console.log('üìç All addresses:', addresses);

                    // Ambil alamat utama (primary=true) atau yang pertama
                    const primaryAddress = addresses.find(addr => addr.is_primary === true || addr.is_primary === 1) || addresses[0];

                    if (primaryAddress) {
                        console.log('üìç Primary address found:', primaryAddress);
                        user.primary_address = primaryAddress;
                        user.address = primaryAddress;
                    } else {
                        console.warn('‚ö†Ô∏è No primary address found');
                    }
                } else {
                    console.warn('‚ùå Failed to fetch addresses:', addressRes.status);
                }
            } catch (err) {
                console.warn('Fetch /user-addresses failed:', err.message);
            }
        }

        // Fallback user
        if (!user) {
            user = {
                id: null,
                name: localStorage.getItem('userName') || 'User',
                email: localStorage.getItem('userEmail') || 'user@example.com',
                phone: localStorage.getItem('userPhone') || ''
            };
        }

        paymentState.userData = user;

        // Log untuk debugging - lihat struktur data lengkap
        console.log('=== USER DATA LENGKAP ===');
        console.log(JSON.stringify(user, null, 2));
        console.log('User keys:', Object.keys(user));
        if (user.profile) console.log('Profile keys:', Object.keys(user.profile));
        if (user.addresses) console.log('Addresses:', user.addresses);

        // Update address display
        updateAddressDisplay(user);

        // Fetch products
        let products = [];
        for (const item of cart) {
            try {
                const prodRes = await fetch(`${API_URL}/products/${item.id}`);
                if (prodRes.ok) {
                    const prodData = await prodRes.json();
                    const product = prodData.data || prodData;

                    products.push({
                        id: product.id,
                        name: product.name || 'Produk',
                        price: product.price || 0,
                        quantity: item.quantity || 1,
                        image_url: (product.image_urls && product.image_urls[0]) || product.image || ''
                    });
                } else {
                    // Fallback product
                    products.push({
                        id: item.id,
                        name: `Produk #${item.id}`,
                        price: 0,
                        quantity: item.quantity || 1,
                        image_url: ''
                    });
                }
            } catch (err) {
                console.warn(`Product ${item.id} fetch failed:`, err.message);
                products.push({
                    id: item.id,
                    name: `Produk #${item.id}`,
                    price: 0,
                    quantity: item.quantity || 1,
                    image_url: ''
                });
            }
        }

        paymentState.cart = cart;
        paymentState.products = products;

        // Update UI
        updateCartDisplayWithControls(products);
        const totals = calculateTotals();
        updateSummaryDisplay(totals);
        updateUserAvatar(user);

        // Setup UI
        setupPaymentButton();
        setupShippingMethodUI();
        loadPaymentMethods();

        console.log('‚úì Payment page loaded successfully');

    } catch (err) {
        console.error('Error loading payment data:', err);
        alert('Gagal memuat data pembayaran: ' + err.message);
    }
}

// Setup payment button
function setupPaymentButton() {
    const payBtn = document.getElementById('paymentButton');

    if (!payBtn) {
        console.error('‚ùå Payment button not found!');
        return;
    }

    console.log('‚úì Payment button found, setting up...');

    payBtn.setAttribute('type', 'button');
    payBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üí≥ Payment button clicked');

        // Save logs to localStorage for persistence
        const saveLog = (msg) => {
            const logs = JSON.parse(localStorage.getItem('payment_debug_logs') || '[]');
            logs.push(`[${new Date().toLocaleTimeString()}] ${msg}`);
            localStorage.setItem('payment_debug_logs', JSON.stringify(logs.slice(-50))); // Keep last 50
            console.log(msg);
        };

        const token = localStorage.getItem('token');
        const totals = calculateTotals();

        if (!paymentState.userData) {
            alert('Data user tidak ditemukan');
            return;
        }

        try {
            payBtn.disabled = true;
            payBtn.textContent = '‚è≥ Memproses...';
            saveLog('üîí Button disabled, processing payment...');

            // Get selected payment method
            const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value || 'gopay';
            saveLog('üí≥ Selected payment method: ' + paymentMethod);
            console.log('üí≥ Payment method:', paymentMethod);

            // Get shipping address from user profile
            let shippingAddress = 'Alamat tidak tersedia';
            if (paymentState.userData) {
                const profile = paymentState.userData.profile || paymentState.userData;
                shippingAddress = profile.full_address || profile.address || 'Alamat tidak tersedia';
            }
            console.log('üìç Shipping address:', shippingAddress);

            // Create order with complete item data
            const orderItems = paymentState.products.map(prod => ({
                product_id: prod.id,
                product_name: prod.name,
                product_image: prod.image_url,
                quantity: prod.quantity,
                price: prod.price
            }));

            console.log('üì° Order data to send:', {
                items: orderItems,
                shipping_address: shippingAddress,
                subtotal: totals.subtotal,
                shipping_cost: totals.shippingCost,
                total: totals.total,
                payment_method: paymentMethod
            });

            saveLog('üì§ Sending order to backend...');

            const res = await fetch(`${API_URL}/orders`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    items: orderItems,
                    shipping_address: shippingAddress,
                    subtotal: totals.subtotal,
                    shipping_cost: totals.shippingCost,
                    total: totals.total,
                    payment_method: paymentMethod
                })
            });

            console.log('üìä Response status:', res.status);

            if (!res.ok) {
                const error = await res.json();
                console.error('‚ùå Order creation error:', error);
                console.error('   Error message:', error.message);
                console.error('   Error details:', error.error?.details);

                // Better error message
                let errorMsg = 'Gagal membuat order: ' + (error.message || 'Unknown error');
                if (error.error?.details) {
                    errorMsg += ' - ' + error.error.details;
                }
                throw new Error(errorMsg);
            }

            const orderData = await res.json();
            console.log('‚úÖ Order created:', orderData);

            // Get snap token from response
            const snapToken = orderData.data?.snap_token || orderData.snap_token;
            console.log('üé´ Snap token type:', typeof snapToken);
            console.log('üé´ Snap token value:', snapToken);
            console.log('üé´ Snap token length:', snapToken ? snapToken.length : 0);

            if (snapToken) {
                console.log('üé´ Snap token received, opening Midtrans payment...');
                console.log('üîç Window.snap:', window.snap);
                console.log('üîç Window.snap type:', typeof window.snap);

                // Check if window.snap is available - if not, wait for script to load
                if (!window.snap) {
                    console.log('‚è≥ Menunggu Midtrans script di-load...');
                    try {
                        const scriptLoaded = await loadMidtransScript();
                        console.log('‚úÖ Midtrans script loading resolved');

                        // Tunggu window.snap siap
                        let waitAttempts = 0;
                        while (!window.snap && waitAttempts < 30) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            waitAttempts++;
                        }

                        if (!window.snap) {
                            throw new Error('window.snap belum tersedia setelah loading');
                        }
                    } catch (scriptError) {
                        console.error('‚ùå Failed to load Midtrans script:', scriptError);
                        alert('Gagal memuat payment gateway. Error: ' + scriptError.message + '\n\nSilakan coba refresh halaman atau gunakan browser lain.');
                        throw scriptError;
                    }
                } else {
                    console.log('‚úì Midtrans script sudah tersedia');
                }

                // Double check window.snap
                console.log('üîç Final check - window.snap:', window.snap);

                if (!window.snap || typeof window.snap.pay !== 'function') {
                    console.error('‚ùå window.snap tidak tersedia atau snap.pay bukan function');
                    alert('Payment gateway Midtrans tidak siap. Silakan:\n1. Refresh halaman\n2. Cek koneksi internet\n3. Coba browser lain');
                    throw new Error('Midtrans Snap tidak tersedia untuk digunakan');
                }

                console.log('‚úÖ window.snap tersedia dan siap untuk pay()');
                console.log('   Token preview:', snapToken.substring(0, 20) + '...');

                try {
                    saveLog('üöÄ Memanggil snap.pay() dengan token: ' + snapToken.substring(0, 15) + '...');
                    console.log('üöÄ Calling snap.pay() dengan callback');

                    // Call snap.pay dengan callback untuk handle hasil
                    window.snap.pay(snapToken, {
                        onSuccess: function(result) {
                            saveLog('‚úÖ Pembayaran sukses!');
                            console.log('‚úÖ Payment success:', result);

                            localStorage.removeItem('cart');
                            sessionStorage.removeItem('cartTotal');
                            alert('Pembayaran berhasil! Terima kasih.');
                            setTimeout(() => {
                                window.location.href = 'Halaman.beranda.html';
                            }, 1000);
                        },
                        onPending: function(result) {
                            saveLog('‚è≥ Pembayaran pending...');
                            console.log('‚è≥ Payment pending:', result);
                            alert('Pembayaran sedang diproses. Silakan tunggu.');
                        },
                        onError: function(result) {
                            saveLog('‚ùå Pembayaran error: ' + result.status_message);
                            console.error('‚ùå Payment error:', result);
                            alert('Pembayaran gagal: ' + result.status_message);
                            payBtn.disabled = false;
                            payBtn.textContent = 'Bayar Sekarang';
                        },
                        onClose: function() {
                            saveLog('‚ùå Pop-up ditutup oleh user');
                            console.log('Pop-up ditutup');
                            payBtn.disabled = false;
                            payBtn.textContent = 'Bayar Sekarang';
                        }
                    });

                    saveLog('‚úÖ snap.pay() berhasil dipanggil');
                    console.log('‚úÖ snap.pay() called with callbacks');

                } catch (payError) {
                    saveLog('‚ùå Error calling snap.pay(): ' + payError.message);
                    console.error('‚ùå Error calling snap.pay():', payError);
                    console.error('   Error message:', payError.message);
                    console.error('   Error stack:', payError.stack);
                    alert('Error calling payment: ' + payError.message);
                    payBtn.disabled = false;
                    payBtn.textContent = 'Bayar Sekarang';
                    throw payError;
                }
            } else {
                saveLog('‚ö†Ô∏è No snap token in response, assuming payment pending');
                console.warn('‚ö†Ô∏è No snap token in response, assuming payment pending');
                // For COD or pending payments without snap token
                localStorage.removeItem('cart');
                sessionStorage.removeItem('cartTotal');
                alert('Order berhasil dibuat! Status pembayaran: ' + (orderData.data?.status || 'pending'));
                setTimeout(() => {
                    window.location.href = 'Halaman.beranda.html';
                }, 1500);
            }

        } catch (err) {
            saveLog('‚ùå PAYMENT ERROR: ' + err.message);
            saveLog('   Stack: ' + (err.stack ? err.stack.substring(0, 200) : 'N/A'));
            console.error('‚ùå Payment error:', err);
            alert('Error: ' + err.message);
            payBtn.disabled = false;
            payBtn.textContent = 'Bayar Sekarang';
        }
    });
}

// Setup Navigation
function setupNavigation() {
    // Logo
    const logoBtn = document.querySelector('a.flex.items-center');
    if (logoBtn) {
        logoBtn.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = 'Halaman.beranda.html';
        });
    }

    // Tombol ubah alamat
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => {
        if (btn.textContent.includes('Ubah Alamat')) {
            btn.classList.remove('hidden');
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                alert('Fitur ubah alamat akan ditambahkan segera.\n\nAlamat saat ini: ' + (paymentState.shippingAddress || 'Belum ada'));
            });
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = 'login.html';
        return;
    }

    // Load payment data only
    loadPaymentData();
    setupNavigation();
});
</script>

</body></html>

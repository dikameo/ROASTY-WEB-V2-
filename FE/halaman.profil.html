<!DOCTYPE html>

<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Roasty - Profil Pengguna</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#f26c0d",
                        "background-light": "#f8f7f5",
                        "background-dark": "#221710",
                        "surface-light": "#ffffff",
                        "surface-dark": "#2a1e16",
                        "text-main-light": "#1c130d",
                        "text-main-dark": "#f4ece7",
                        "text-sub-light": "#9c6c49",
                        "text-sub-dark": "#bda088",
                        "border-light": "#f4ece7",
                        "border-dark": "#3e2b22",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
</head>
<body class="bg-background-light dark:bg-background-dark font-display antialiased transition-colors duration-200">
<!-- Top Navigation Bar -->
<header class="sticky top-0 z-50 w-full bg-surface-light dark:bg-surface-dark border-b border-border-light dark:border-border-dark shadow-sm">
<div class="max-w-[1280px] mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex items-center justify-between h-16 gap-4 sm:gap-8">
<!-- Logo -->
<a href="#" id="logoBtn" class="flex items-center gap-2 text-primary shrink-0 hover:opacity-80 transition-opacity">
<div class="size-8 text-primary">
<svg class="h-8 w-8" fill="none" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path d="M24 4C25.7818 14.2173 33.7827 22.2182 44 24C33.7827 25.7818 25.7818 33.7827 24 44C22.2182 33.7827 14.2173 25.7818 4 24C14.2173 22.2182 22.2182 14.2173 24 4Z" fill="currentColor"></path>
</svg>
</div>
<h1 class="text-2xl font-bold tracking-tight text-text-main-light dark:text-text-main-dark hidden sm:block">Roasty</h1>
</a>
<!-- Right Actions -->
<div class="flex items-center gap-2 sm:gap-6">
<nav class="hidden lg:flex items-center gap-6">
</nav>
<div class="flex items-center gap-2 border-l border-border-light dark:border-border-dark pl-2 sm:pl-6">
<!-- Admin Button - Only for Admin Users -->
<a id="admin-button" href="admin_dashboard.html" class="hidden items-center gap-2 px-4 py-2 bg-gradient-to-r from-orange-500 to-orange-600 dark:from-orange-600 dark:to-orange-700 text-white rounded-lg hover:shadow-lg transition-all text-sm font-semibold whitespace-nowrap">
<span class="material-symbols-outlined text-lg">admin_panel_settings</span>
<span class="hidden md:inline">Admin Panel</span>
</a>

<!-- User Navigation Icons -->
<div id="user-icons" class="flex items-center gap-2">
<!-- Cart Icon -->
<button id="cart-button" class="hidden relative p-2 text-text-main-light dark:text-text-main-dark hover:bg-background-light dark:hover:bg-background-dark rounded-full transition-colors">
<span class="material-symbols-outlined text-[24px]">shopping_cart</span>
<span id="cart-badge" class="absolute top-1 right-1 h-5 w-5 rounded-full bg-primary text-white ring-2 ring-white dark:ring-surface-dark flex items-center justify-center text-[10px] font-bold hidden">0</span>
</button>

<!-- Notification Icon -->
<button id="notification-button" class="hidden relative p-2 text-text-main-light dark:text-text-main-dark hover:bg-background-light dark:hover:bg-background-dark rounded-full transition-colors">
<span class="material-symbols-outlined text-[24px]">notifications</span>
<span id="notification-badge" class="absolute top-1 right-1 h-2 w-2 rounded-full bg-primary hidden"></span>
</button>
</div>
</div>

<!-- Profile Avatar -->
<div class="h-9 w-9 rounded-full bg-cover bg-center border-2 border-white dark:border-surface-dark shadow-sm cursor-pointer" id="profile-avatar" data-alt="User profile picture"></div>
</div>
</div>
</div>
</header>
<!-- Main Layout -->
<main class="max-w-[1280px] mx-auto px-4 sm:px-6 lg:px-8 py-6">
<!-- Breadcrumbs -->
<nav class="flex mb-6 text-sm font-medium text-text-sub-light dark:text-text-sub-dark">
</nav>
<div class="flex flex-col lg:flex-row gap-6">
<!-- Sidebar -->
<aside class="w-full lg:w-64 flex-shrink-0">
<div class="bg-surface-light dark:bg-surface-dark rounded-xl shadow-sm border border-border-light dark:border-border-dark overflow-hidden">
<!-- User Mini Profile -->
<div class="p-4 border-b border-border-light dark:border-border-dark flex items-center gap-3">
<div class="h-12 w-12 rounded-full bg-cover bg-center" id="miniProfileAvatar" data-alt="Small user avatar"></div>
<div class="flex flex-col">
<span class="text-sm font-bold text-text-main-light dark:text-text-main-dark" id="miniProfileName">-</span>
<div class="flex items-center gap-1">
<span class="material-symbols-outlined text-xs text-yellow-500 fill-current">stars</span>
<span class="text-xs text-text-sub-light dark:text-text-sub-dark" id="miniProfileMember">-</span>
</div>
</div>
</div>
<!-- Navigation Menu -->
<div class="p-2">
<a class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-primary/10 text-primary font-medium transition-colors" href="#">
<span class="material-symbols-outlined text-[20px]">person</span>
<span class="text-sm">Biodata Diri</span>
</a>
<a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-text-main-light dark:text-text-main-dark hover:bg-background-light dark:hover:bg-background-dark transition-colors group" href="#">
<span class="material-symbols-outlined text-[20px] text-text-sub-light dark:text-text-sub-dark group-hover:text-primary">location_on</span>
<span class="text-sm font-medium">Daftar Alamat</span>
</a>
<a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-text-main-light dark:text-text-main-dark hover:bg-background-light dark:hover:bg-background-dark transition-colors group" href="#">
<span class="material-symbols-outlined text-[20px] text-text-sub-light dark:text-text-sub-dark group-hover:text-primary">credit_card</span>
<span class="text-sm font-medium">Pembayaran</span>
</a>
<a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-text-main-light dark:text-text-main-dark hover:bg-background-light dark:hover:bg-background-dark transition-colors group" href="#">
<span class="material-symbols-outlined text-[20px] text-text-sub-light dark:text-text-sub-dark group-hover:text-primary">inventory_2</span>
<span class="text-sm font-medium">Riwayat Pesanan</span>
</a>
<div class="my-2 border-t border-border-light dark:border-border-dark"></div>
<a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-text-main-light dark:text-text-main-dark hover:bg-background-light dark:hover:bg-background-dark transition-colors group" href="#">
<span class="material-symbols-outlined text-[20px] text-text-sub-light dark:text-text-sub-dark group-hover:text-primary">settings</span>
<span class="text-sm font-medium">Pengaturan</span>
</a>
<div class="my-2 border-t border-border-light dark:border-border-dark"></div>
<button id="logoutBtn" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-text-main-light dark:text-text-main-dark hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors group cursor-pointer border-0 bg-transparent">
<span class="material-symbols-outlined text-[20px] text-red-500 group-hover:text-red-600">logout</span>
<span class="text-sm font-medium text-red-500 group-hover:text-red-600">Logout</span>
</button>
</div>
</div>
</aside>
<!-- Main Content Area -->
<div class="flex-1 min-w-0 space-y-6">
<!-- Profile Header Card -->
<div class="bg-surface-light dark:bg-surface-dark rounded-xl shadow-sm border border-border-light dark:border-border-dark p-6">
<div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-6">
<div class="flex items-center gap-6">
<div class="relative group cursor-pointer">
<div class="h-24 w-24 rounded-full bg-cover bg-center border-4 border-background-light dark:border-background-dark shadow-sm" id="largeProfileAvatar" data-alt="Large user avatar"></div>
<div class="absolute bottom-0 right-0 p-1.5 bg-primary rounded-full text-white shadow-sm border-2 border-white dark:border-surface-dark group-hover:scale-110 transition-transform">
<span class="material-symbols-outlined text-[16px] block">edit</span>
</div>
</div>
<div>
<h2 class="text-xl font-bold text-text-main-light dark:text-text-main-dark" id="profileName">-</h2>
<p class="text-text-sub-light dark:text-text-sub-dark text-sm mt-1" id="profileJoinDate">-</p>
<div class="mt-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">
                                    Akun Terverifikasi
                                </div>
</div>
</div>
<button class="w-full sm:w-auto px-4 py-2 bg-background-light dark:bg-background-dark hover:bg-gray-100 dark:hover:bg-gray-800 text-text-main-light dark:text-text-main-dark rounded-lg text-sm font-bold border border-border-light dark:border-border-dark transition-colors">
                            Ubah Foto Profil
                        </button>
</div>
</div>
<!-- Form Section -->
<div class="bg-surface-light dark:bg-surface-dark rounded-xl shadow-sm border border-border-light dark:border-border-dark overflow-hidden">
<div class="px-6 py-4 border-b border-border-light dark:border-border-dark flex justify-between items-center">
<h3 class="text-lg font-bold text-text-main-light dark:text-text-main-dark">Ubah Biodata Diri</h3>
<span class="text-xs text-text-sub-light dark:text-text-sub-dark" id="lastUpdateTime">-</span>
</div>
<div class="p-6">
<form action="#" class="space-y-6">
<!-- Name & Username -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="space-y-2">
<label class="block text-sm font-medium text-text-main-light dark:text-text-main-dark" for="fullname">
                                        Nama Lengkap
                                    </label>
<input class="block w-full rounded-lg border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark text-text-main-light dark:text-text-main-dark text-sm focus:ring-primary focus:border-primary px-4 py-2.5" id="fullname" placeholder="Masukkan nama lengkap" type="text"/>
<p class="text-xs text-text-sub-light dark:text-text-sub-dark">Nama akan ditampilkan di profil publik.</p>
</div>
<div class="space-y-2">
<label class="block text-sm font-medium text-text-main-light dark:text-text-main-dark" for="username">
                                        Username
                                    </label>
<div class="flex rounded-lg shadow-sm">
<span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-border-light dark:border-border-dark bg-gray-50 dark:bg-surface-dark text-text-sub-light dark:text-text-sub-dark text-sm">
                                            @
                                        </span>
<input class="flex-1 block w-full rounded-none rounded-r-lg border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark text-text-main-light dark:text-text-main-dark text-sm focus:ring-primary focus:border-primary px-4 py-2.5" id="username" type="text"/>
</div>
</div>
</div>
<!-- Date of Birth & Gender -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="space-y-2">
<label class="block text-sm font-medium text-text-main-light dark:text-text-main-dark">
                                        Tanggal Lahir
                                    </label>
<input class="block w-full rounded-lg border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark text-text-main-light dark:text-text-main-dark text-sm focus:ring-primary focus:border-primary px-4 py-2.5" id="birthdate" type="date"/>
</div>
<div class="space-y-2">
<label class="block text-sm font-medium text-text-main-light dark:text-text-main-dark">
                                        Jenis Kelamin
                                    </label>
<div class="flex gap-4">
<label class="flex items-center gap-2 cursor-pointer">
<input class="text-primary focus:ring-primary border-gray-300 dark:border-gray-600 bg-transparent" id="genderMale" name="gender" type="radio" value="male"/>
<span class="text-sm text-text-main-light dark:text-text-main-dark">Laki-laki</span>
</label>
<label class="flex items-center gap-2 cursor-pointer">
<input class="text-primary focus:ring-primary border-gray-300 dark:border-gray-600 bg-transparent" id="genderFemale" name="gender" type="radio" value="female"/>
<span class="text-sm text-text-main-light dark:text-text-main-dark">Perempuan</span>
</label>
</div>
</div>
</div>
<hr class="border-border-light dark:border-border-dark"/>
<!-- Contact Info -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="space-y-2">
<label class="block text-sm font-medium text-text-main-light dark:text-text-main-dark">
                                        Email
                                    </label>
<div class="relative">
<input class="block w-full rounded-lg border-border-light dark:border-border-dark bg-gray-50 dark:bg-surface-dark text-text-sub-light dark:text-text-sub-dark text-sm px-4 py-2.5 cursor-not-allowed" id="email" disabled="" type="email"/>
<span class="absolute right-3 top-2.5 text-xs font-bold text-green-600 flex items-center gap-1">
<span class="material-symbols-outlined text-[16px]">check_circle</span>
                                            Terverifikasi
                                        </span>
</div>
<a class="text-xs font-medium text-primary hover:underline" href="#">Ubah Email</a>
</div>
<div class="space-y-2">
<label class="block text-sm font-medium text-text-main-light dark:text-text-main-dark">
                                        Nomor HP
                                    </label>
<div class="relative">
<input class="block w-full rounded-lg border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark text-text-main-light dark:text-text-main-dark text-sm px-4 py-2.5" id="phone" type="text"/>
</div>
<p class="text-xs text-text-sub-light dark:text-text-sub-dark">Format: +62 XXX XXXX XXXX</p>
</div>
</div>
</form>
</div>
<!-- Footer Actions -->
<div class="px-6 py-4 bg-background-light dark:bg-background-dark border-t border-border-light dark:border-border-dark flex items-center justify-end gap-3">
<button class="px-6 py-2.5 rounded-lg text-sm font-bold text-text-sub-light dark:text-text-sub-dark hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                            Batal
                        </button>
<button class="px-6 py-2.5 rounded-lg bg-primary hover:bg-orange-600 text-white text-sm font-bold shadow-sm shadow-orange-500/30 transition-all transform active:scale-95">
                            Simpan Perubahan
                        </button>
</div>
</div>
<!-- Recent Order / Snippet Section (To fulfill requirement to see orders) -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<!-- Primary Address Preview -->
<div class="bg-surface-light dark:bg-surface-dark rounded-xl shadow-sm border border-border-light dark:border-border-dark p-6">
<div class="flex justify-between items-center mb-4">
<h3 class="text-base font-bold text-text-main-light dark:text-text-main-dark">Alamat Utama</h3>
<a class="text-sm font-medium text-primary hover:underline" href="#">Lihat Semua</a>
</div>
<div id="primaryAddress" class="p-4 rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark">
<div class="flex items-start gap-3">
<span class="material-symbols-outlined text-text-sub-light mt-0.5">home</span>
<div>
<p class="text-sm font-bold text-text-main-light dark:text-text-main-dark" id="addressName">-</p>
<p class="text-sm text-text-sub-light dark:text-text-sub-dark mt-1 leading-relaxed" id="addressDetails">-</p>
</div>
</div>
</div>
</div>
<!-- Last Order Preview -->
<div class="bg-surface-light dark:bg-surface-dark rounded-xl shadow-sm border border-border-light dark:border-border-dark p-6">
<div class="flex justify-between items-center mb-4">
<h3 class="text-base font-bold text-text-main-light dark:text-text-main-dark">Pesanan Terakhir</h3>
<a class="text-sm font-medium text-primary hover:underline" href="#">Riwayat</a>
</div>
<div id="lastOrder" class="p-4 rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark">
<div class="flex items-center gap-4">
<div class="h-16 w-16 rounded-lg bg-white dark:bg-surface-dark p-1 border border-border-light dark:border-border-dark flex-shrink-0">
<div class="w-full h-full bg-cover bg-center rounded" id="lastOrderImage" data-alt="Product image"></div>
</div>
<div class="flex-1 min-w-0">
<p class="text-sm font-bold text-text-main-light dark:text-text-main-dark truncate" id="lastOrderName">-</p>
<p class="text-xs text-text-sub-light dark:text-text-sub-dark mt-0.5" id="lastOrderDate">-</p>
<div class="mt-2 flex items-center gap-2">
<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-400" id="lastOrderStatus">-</span>
<span class="text-xs font-semibold text-primary" id="lastOrderPrice">-</span>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</main>

<script src="config.js"></script>
<script src="navbar-helper.js"></script>
<script>
const API_URL = CONFIG.API_BASE_URL;

// Helper function untuk fetch dengan token
async function fetchWithAuth(url, options = {}) {
    const token = localStorage.getItem('token');
    
    if (!token) {
        throw new Error('Token not found');
    }
    
    const headers = {
        'Accept': 'application/json',
        'Authorization': `Bearer ${token}`,
        ...options.headers
    };
    
    const response = await fetch(url, {
        ...options,
        headers
    });
    
    return response;
}

// Format date untuk display
function formatDate(dateString) {
    if (!dateString) return '-';
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return new Date(dateString).toLocaleDateString('id-ID', options);
}

// Format currency
function formatCurrency(amount) {
    if (!amount) return 'Rp 0';
    return 'Rp ' + amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

// Load user profile data
async function loadProfile() {
    const token = localStorage.getItem('token');
    
    if (!token) {
        alert('Silakan login terlebih dahulu');
        window.location.href = 'login.html';
        return;
    }
    
    try {
        console.log('Token exists:', !!token);
        console.log('Token length:', token.length);
        console.log('API URL:', `${API_URL}/me`);
        
        // Use /me endpoint instead of /profile for better compatibility
        const res = await fetchWithAuth(`${API_URL}/me`, {
            method: 'GET'
        });
        
        console.log('Response status:', res.status);
        console.log('Response headers:', res.headers);
        
        if (!res.ok) {
            const errorData = await res.json();
            console.error('Error response:', errorData);
            
            if (res.status === 401) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                alert('Sesi Anda telah berakhir. Silakan login kembali.');
                window.location.href = 'login.html';
            }
            throw new Error('Gagal memuat profil: ' + (errorData.message || res.statusText));
        }
        
        const data = await res.json();
        const profile = data.data || data;
        
        console.log('Profile data:', profile);
        
        // Handle nested structure from API
        const profileData = profile.profile || profile;
        const userData = profile.user || profile;
        
        // Get full name from user data or profile
        const firstName = userData.first_name || userData.name?.split(' ')[0] || '';
        const lastName = userData.last_name || userData.name?.split(' ').slice(1).join(' ') || '';
        const fullName = `${firstName} ${lastName}`.trim() || userData.name || 'User';
        
        // Update profile data di form
        document.getElementById('fullname').value = fullName;
        document.getElementById('username').value = userData.username || '';
        document.getElementById('email').value = userData.email || '';
        document.getElementById('phone').value = profileData?.phone || userData.phone || '';
        document.getElementById('birthdate').value = profileData?.birth_date || userData.birth_date || '';
        
        // Update gender
        if (profileData?.gender || userData.gender) {
            const genderVal = profileData?.gender || userData.gender;
            const genderInput = document.querySelector(`input[name="gender"][value="${genderVal}"]`);
            if (genderInput) {
                genderInput.checked = true;
            }
        }
        
        // Update mini profile di sidebar
        document.getElementById('miniProfileName').textContent = fullName;
        document.getElementById('miniProfileMember').textContent = profileData?.membership_level || userData.membership_level || 'Member';
        if (profileData?.profile_image || userData.profile_image) {
            document.getElementById('miniProfileAvatar').style.backgroundImage = `url('${profileData?.profile_image || userData.profile_image}')`;
        }
        
        // Update large profile avatar
        if (profileData?.profile_image || userData.profile_image) {
            document.getElementById('largeProfileAvatar').style.backgroundImage = `url('${profileData?.profile_image || userData.profile_image}')`;
        }
        
        // Update profile name
        document.getElementById('profileName').textContent = fullName;
        document.getElementById('profileJoinDate').textContent = `Bergabung sejak ${formatDate(userData.created_at || profileData?.created_at)}`;
        
        // Update last update time
        const lastUpdate = userData.updated_at || profileData?.updated_at ? formatDate(userData.updated_at || profileData?.updated_at) : '-';
        document.getElementById('lastUpdateTime').textContent = `Terakhir diupdate: ${lastUpdate}`;
        
        // Load addresses
        await loadAddresses(token, userData.id);
        
        // Load orders
        await loadLastOrder(token);
        
    } catch (err) {
        console.error('Error loading profile:', err);
        alert('Gagal memuat profil: ' + err.message);
    }
}

// Load user addresses
async function loadAddresses(token, userId) {
    try {
        const res = await fetchWithAuth(`${API_URL}/addresses`, {
            method: 'GET'
        });
        
        if (!res.ok) {
            console.error('Gagal memuat alamat');
            return;
        }
        
        const data = await res.json();
        const addresses = data.data || data || [];
        
        if (addresses.length > 0) {
            const primaryAddress = addresses.find(addr => addr.is_primary) || addresses[0];
            
            const addressNameEl = document.getElementById('addressName');
            const addressDetailsEl = document.getElementById('addressDetails');
            
            addressNameEl.textContent = `${primaryAddress.label || 'Alamat'} (${primaryAddress.recipient_name || '-'})`;
            
            let addressText = `${primaryAddress.address || ''}<br/>`;
            if (primaryAddress.province) {
                addressText += `${primaryAddress.province}`;
                if (primaryAddress.city) addressText += `, ${primaryAddress.city}`;
                addressText += ' ' + (primaryAddress.postal_code || '') + '<br/>';
            }
            addressText += `<span class="text-xs">${primaryAddress.phone || ''}</span>`;
            
            addressDetailsEl.innerHTML = addressText;
        }
    } catch (err) {
        console.error('Error loading addresses:', err);
    }
}

// Load last order
async function loadLastOrder(token) {
    try {
        const res = await fetchWithAuth(`${API_URL}/orders?limit=1&sort=-created_at`, {
            method: 'GET'
        });
        
        if (!res.ok) {
            console.error('Gagal memuat pesanan');
            return;
        }
        
        const data = await res.json();
        const orders = data.data || data || [];
        
        if (orders.length > 0) {
            const order = orders[0];
            const items = order.items || [];
            
            if (items.length > 0) {
                const firstItem = items[0];
                
                document.getElementById('lastOrderName').textContent = firstItem.product_name || firstItem.name || '-';
                document.getElementById('lastOrderDate').textContent = formatDate(order.created_at);
                document.getElementById('lastOrderStatus').textContent = order.status || 'Pending';
                document.getElementById('lastOrderPrice').textContent = formatCurrency(order.total_price || order.total);
                
                if (firstItem.product_image || firstItem.image) {
                    document.getElementById('lastOrderImage').style.backgroundImage = `url('${firstItem.product_image || firstItem.image}')`;
                }
            }
        } else {
            document.getElementById('lastOrder').innerHTML = '<p class="text-text-sub-light dark:text-text-sub-dark">Belum ada pesanan</p>';
        }
    } catch (err) {
        console.error('Error loading orders:', err);
    }
}

// Save profile changes
function setupSaveButton() {
    const saveBtn = Array.from(document.querySelectorAll('button')).find(btn => 
        btn.textContent.includes('Simpan')
    );
    
    if (saveBtn) {
        saveBtn.setAttribute('type', 'button');
        saveBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            try {
                // Collect form data
                const fullName = document.getElementById('fullname').value;
                const [firstName, ...lastNameParts] = fullName.split(' ');
                const lastName = lastNameParts.join(' ');
                
                const formData = {
                    first_name: firstName,
                    last_name: lastName,
                    username: document.getElementById('username').value,
                    phone: document.getElementById('phone').value,
                    birth_date: document.getElementById('birthdate').value,
                    gender: document.querySelector('input[name="gender"]:checked')?.value
                };
                
                const res = await fetchWithAuth(`${API_URL}/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.message || 'Gagal menyimpan profil');
                }
                
                alert('Profil berhasil diperbarui!');
                loadProfile();
                
            } catch (err) {
                alert('Error: ' + err.message);
                console.error(err);
            }
        });
    }
}

// Setup Cancel Button
function setupCancelButton() {
    const cancelBtn = Array.from(document.querySelectorAll('button')).find(btn => 
        btn.textContent.includes('Batal')
    );
    
    if (cancelBtn) {
        cancelBtn.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = 'Halaman.beranda.html';
        });
    }
}

// Setup Navigation
function setupNavigation() {
    // Cart button
    const cartBtn = document.querySelector('button[class*="p-2"] span.material-symbols-outlined');
    if (cartBtn && cartBtn.textContent.includes('shopping_cart')) {
        cartBtn.closest('button')?.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = 'halaman.keranjang.belanja.html';
        });
    }
}

// Setup Logout
function setupLogout() {
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (confirm('Apakah Anda yakin ingin logout?')) {
                // Hapus token dari localStorage
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                localStorage.removeItem('cart');
                
                // Redirect ke halaman login
                window.location.href = 'login.html';
            }
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = 'login.html';
        return;
    }
    
    // Setup logo click
    const logoBtn = document.getElementById('logoBtn');
    if (logoBtn) {
        logoBtn.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = 'Halaman.beranda.html';
        });
    }
    
    loadProfile();
    setupSaveButton();
    setupCancelButton();
    setupNavigation();
    setupLogout();
});
</script>

</body></html>